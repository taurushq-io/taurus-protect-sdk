syntax = "proto3";

package tgvalidatord;

import "google/api/annotations.proto";
import "protoc-gen-openapiv2/options/annotations.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

import "user-device.proto";

option java_package = "com.taurushq.sdk.protect.proto.v1";

option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
  info: {
    title: "tg-validatord device service";
    version:"1.0";
    contact:{
      name:"tg-validatord device service";
      url:"https://github.com/taurusgroup/tg-validatord";
      email:"development@taurusgroup.ch";
    };
  };
  consumes:"application/json";
  produces:"application/json";
  schemes: [HTTP, HTTPS];
  security_definitions:{
    security:{
      key:"Bearer";
      value:{
        type:TYPE_API_KEY;
        in:IN_HEADER;
        name:"Authorization";
      }
    }
  }
  security:{
    security_requirement:{
      key:"Bearer";
      value:{};
    }
  }
  responses:{
    key:"401";
    value:{
      description:"Returned when the user is not authenticated.";
    }
  }
  responses:{
    key:"403";
    value:{
      description:"Returned when the user is not authorized to access the resource.";
    }
  }
  responses:{
    key:"404";
    value:{
      description:"Returned when the resource does not exist.";
    }
  }

};

message CreateUserDevicePairingReply {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      required: ["pairingID"]
    }
  };
  string pairingID = 1;
}

message StartUserDevicePairingRequest {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      required: ["nonce", "publicKey"]
    }
  };
  string pairingID = 1;
  string nonce = 2 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "A 6 digits number",
  }];
  string publicKey = 3 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "ECDSA publickey encoded in base64 format",
  }];
}

message UserDevicePairingRequest {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      required: ["nonce"]
    }
  };
  string pairingID = 1;
  string nonce = 2 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "A 6 digits number"
  }];
}

service UserDeviceService {
  rpc StartUserDevicePairing (StartUserDevicePairingRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/api/rest/v1/user-device/pairing/{pairingID}/start"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Starts a user's device pairing request (Step 2)";
      description: "It starts a specific pairing process. The nonce and user's device encryption key will be used to validate futures requests.";
      tags: "User Device";
      security: {};
    };
  };

  rpc ApproveUserDevicePairing (UserDevicePairingRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/api/rest/v1/user-device/pairing/{pairingID}/approve"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Approves a user's device pairing request (Step 3)";
      description: "Final approval of the pairing request. It checks the validity of the nonce and finally pairs the device.";
      tags: "User Device";
    };
  };

  rpc GetUserDevicePairingStatus (UserDevicePairingRequest) returns (UserDevicePairingInfo) {
    option (google.api.http) = {
      get: "/api/rest/v1/user-device/pairing/{pairingID}/status"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get the status of a user's device pairing request";
      description: "This endpoint returns the status of a user's device pairing request. A pairing request is identified by its pairingID and the nonce used to start the pairing.";
      tags: "User Device";
      security: {};
    };
  };

  rpc CreateUserDevicePairing (google.protobuf.Empty) returns (CreateUserDevicePairingReply) {
    option (google.api.http) = {
      post: "/api/rest/v1/user-device/pairing"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Create a pairing request (Step 1)";
      description: "This endpoint creates a pairing request for the current user. A pairingID is then returned and is meant to be used by the user's device to complete the pairing process.";
      tags: "User Device";
    };
  };
}
