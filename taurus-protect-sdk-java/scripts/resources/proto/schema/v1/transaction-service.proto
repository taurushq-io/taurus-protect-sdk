syntax = "proto3";

package tgvalidatord;

import "google/api/annotations.proto";
import "protoc-gen-openapiv2/options/annotations.proto";
import "transaction.proto";
import "google/protobuf/timestamp.proto";

option java_package = "com.taurushq.sdk.protect.proto.v1";

option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
  info: {
    title: "tg-validatord transaction service";
    version:"1.0";
    contact:{
      name:"tg-validatord transaction service";
      url:"https://github.com/taurusgroup/tg-validatord";
      email:"development@taurusgroup.ch";
    };
  };
  consumes:"application/json";
  produces:"application/json";
  schemes: [HTTP, HTTPS];
  security_definitions:{
    security:{
      key:"Bearer";
      value:{
        type:TYPE_API_KEY;
        in:IN_HEADER;
        name:"Authorization";
      }
    }
  }
  security:{
    security_requirement:{
      key:"Bearer";
      value:{};
    }
  }
  responses:{
    key:"401";
    value:{
      description:"Returned when the user is not authenticated.";
    }
  }
  responses:{
    key:"403";
    value:{
      description:"Returned when the user is not authorized to access the resource.";
    }
  }
  responses:{
    key:"404";
    value:{
      description:"Returned when the resource does not exist.";
    }
  }
};

message GetTransactionsRequest {
  string currency = 1 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Filter on ID or symbol of the currency";
    }
  ];
  string direction = 2 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "The direction of the transaction (e.g. `incoming`, `outgoing`)";
    }
  ];
  string query = 3 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Filter by query string in any of the fields address, customerid, transactionid, hash, type.";
    }
  ];
  uint64 limit = 4 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "The amount of transactions returned per request. Max 100.";
    }
  ];
  uint64 offset = 5 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "The offset from which to begin selection of transactions.";
    }
  ];
  google.protobuf.Timestamp from = 6 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Only return transactions from after this timestamp.";
    }
  ];
  google.protobuf.Timestamp to = 7 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Only return transactions from before this timestamp.";
    }
  ];
  repeated string transactionIds = 8 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Filter on Protect internal transactionID. This is purely internal and should rarely be used by clients";
    }
  ];
  string type = 9 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "The type of transactions to fetch (e.g. `burn`).";
    }
  ];
  string source = 10 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Returns only transaction that have this address as a source";
    }
  ];
  string destination = 11 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Returns only transaction that have this address as a destination";
    }
  ];
  repeated uint64 ids = 12 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Filter on Protect transaction ID, as visible in the transaction objects.";
    }
  ];
  string blockchain = 13 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "The blockchain associated with the transactions (e.g. `ETH`, `BTC`)";
    }
  ];
  string network = 14 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "The network the transaction took place in (e.g. `mainnet`, `testnet`).";
    }
  ];
  uint64 fromBlockNumber = 15 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Only return transactions from after this block.";
    }
  ];
  uint64 toBlockNumber = 16 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Only return transactions from before this block.";
    }
  ];
  repeated string hashes = 17 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Filter on transaction hash, as visible in the transaction objects.";
    }
  ];
  string address = 18 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Returns only transaction that have this address as either a source or a destination";
    }
  ];
  string amountAbove = 19 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Returns only transactions with an amount strictly above the given amount";
    }
  ];
  bool excludeUnknownSourceDestination = 20 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Returns only transactions with a known source and destination, default false";}
  ]
  ;
  string customerId = 21 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Returns only transactions with a specific customer id";}
  ]
  ;
}

message ExportTransactionsRequest {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    example: "?limit=5000&from=2022-01-28T00:00:00+01:00&to=2022-01-31T23:59:59+01:00&format=json"
  };

  string currency = 1 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Filter on ID or symbol of the currency";}];
  string direction = 2;
  string query = 3;
  uint64 limit = 4;
  uint64 offset = 5;
  google.protobuf.Timestamp from = 6;
  google.protobuf.Timestamp to = 7;
  repeated string transactionIds = 8;
  string format = 9 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Desired file format, can be json, csv or csv_simple.";
    }
  ];
  string type = 10;
  string source = 11 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Returns only transaction that have this address as a source";}];
  string destination = 12 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Returns only transaction that have this address as a destination";}];
  repeated uint64 ids = 13 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Filter on Protect transaction ID, as visible in the transaction objects.";}];
  string blockchain = 14;
  string network = 15;
  uint64 fromBlockNumber = 16;
  uint64 toBlockNumber = 17;
  string amountAbove = 18 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Returns only transactions with an amount strictly above the given amount";}];
  bool excludeUnknownSourceDestination = 19 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Returns only transactions with a known source and destination, default false";}];
  repeated string hashes = 20 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Filter on transaction hash, as visible in the transaction objects.";}];
  string address = 21 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Returns only transaction that have this address as either a source or a destination";}];
}

message GetTransactionsReply{
  repeated Transaction result = 1;
  uint64 totalItems = 2 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "The total number of transactions.";
    }
  ];
}

message ExportTransactionsReply{
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    example: "{\"result\":\"id,tenant_id,blockchain,currency,decimals,transaction_id,direction,sources -- records sep: \'#\' fields sep: \'|\' -- format: f11|f12#f21|f22#f31|f32 -- example: address|label|container|customer_id|amount|amount_main_unit|index|balance_before_transaction|balance_after_transaction|balance_after_transaction_base#address|label|container|customer_id|amount|amount_main_unit|index|balance_before_transaction|balance_after_transaction|balance_after_transaction_base#...,destinations -- records sep: \'#\' fields sep: \'|\' -- format: f11|f12#f21|f22#f31|f32 -- example: address|label|container|customer_id|amount|amount_main_unit|index|balance_before_transaction|balance_after_transaction|balance_after_transaction_base#address|label|container|customer_id|amount|amount_main_unit|index|balance_before_transaction|balance_after_transaction|balance_after_transaction_base#...,amount,amount_main_unit,fee,fee_main_unit,hash,block,reception_date,confirmation_date,isin,type 41567,1,ETH,ETH,18,200951:a3652402-b069-4e7d-928d-07b2d6634dea,outgoing,0x312d2a29c3adfc1360088b19a5157afa07971f40|1.10 TESTS TC|70005500.059|cust3|||0,||||||0,0,0,210826220912126535,0.210826220912126535,0x06273e6e59eea48b5508c1870e3f378742012c3d489a40826ae65b0b4890261a,14113487,2022-01-31T11:52:27Z,2022-01-31T12:00:31.164524Z,, 41566,1,XTZ,XTZ,6,,incoming,tz1WpH8peQDkYFhkuKw17KnrT4uWvAKKULwh||||||244,tz1STvLfC96TxvNFq9bsFCPvd4UJLyM5vCTf|Baker address||123456|||244,4654,0.004654,395,0.000395,opRLVnsgHUqpcU9Yoxh9Zz7HtmVJX2mh33CqEZPcsJD1U5t5gc1,2073113,2022-01-29T21:48:08Z,2022-01-29T21:55:45.977156Z,,transaction 41565,1,XTZ,XTZ,6,,incoming,tz1hTJnYMKSDUv55yREM8ezmC5nsdbPUWao7|Baker: Steak and Bake (tz1dNVDWPf3Q59SdJqnjdnu277iyvReiRS9M)|||||0,tz1SNaBji6Ex1ng4FHnA1iDBKx72CTjzCRTe|Laurent Tezos New addr 23.02.2021||3|||183,428,0.000428,395,0.000395,oorRPKNM6dXgeVKfLL2dHJfKVeNXebJ1MZAWPuKNKPckHJFJEyR,2072668,2022-01-29T18:03:18Z,2022-01-29T18:15:32.647506Z,,staking_reward 41563,1,XTZ,XTZ,6,,incoming,tz1imZ4ZKk9ukiU9GdLLvmsAhCVuznfTyjKD||||||298,tz1MrohofV2P9B9hojk1SMo5M1FYUfBTNYtd|May29 test address 1||1|||298,3004,0.003004,395,0.000395,ooNMBvR2FhNYD2anmFemmtwnviepqXhmAmqK7t89pPzRdPTPU1u,2072639,2022-01-29T17:48:48Z,2022-01-29T17:57:55.522667Z,,transactio 41562,1,XTZ,XTZ,6,,incoming,tz1LsnEuv4fLsgxU9HJK21v8zHwcuBjb99Cd|Baker: Lucid Mining (tz1VmiY38m3y95HqQLjMwqnMS7sdMfGomzKi)|||||0,tz1NPahQw1yZ3ENSFGbszbj2tMmTxjAUkQa2|address sep. 23||X1234|||19,2158,0.002158,0,0,op3FzkUgdsVMSnE6tdyZ77Ys6WSKruxP2yCsgDo6NU1LC4BTctf,2072639,2022-01-29T17:48:48Z,2022-01-29T17:57:43.89606Z,,staking_rewar \",\"totalItems\":\"5\"}"
  };

  string result = 1;
  uint64 totalItems = 2;
}

message ExportTransactionTravelRuleRequest {
  uint64 transactionID = 1;
  string format = 2 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Desired output format, can be json or iso20022_pacs008_xml.";
    }
  ];
}


message ExportTransactionTravelRuleReply {
  string result = 1;
}


service TransactionService {
  rpc GetTransactions (GetTransactionsRequest) returns (GetTransactionsReply) {
    option (google.api.http) = {
      get: "/api/rest/v1/transactions"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "List transactions";
      description: "This endpoint returns a list of transactions based on the provided query parameters.\n\n"
          "You must specify either a `currency` (by ID or symbol) or a combination of `blockchain` and `network`.\n\n"
          "- If `currency` is provided, `blockchain` and `network` cannot be used.\n"
          "- If `currency` is not provided, you may use `blockchain`, `network`, or both together.\n\n"
          "Only one of these approaches is allowed per request.\n\n"
          "The `currencyID` is unique across blockchains and networks, and can be identified by querying the `/currencies` endpoint. "
          "We recommend using `currencyID` whenever possible to avoid ambiguity.";
      tags: "Transactions";
    };
  };

  rpc ExportTransactions (ExportTransactionsRequest) returns (ExportTransactionsReply) {
    option (google.api.http) = {
      get: "/api/rest/v1/transactions/export"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Export transactions";
      description: "This endpoint exports a list of transactions";
      tags: "Transactions";
    };
  };

  rpc ExportTransactionTravelRule (ExportTransactionTravelRuleRequest) returns (ExportTransactionTravelRuleReply) {
    option (google.api.http) = {
      get: "/api/rest/v1/transactions/{transactionID}/travelrule/export"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Export the travel rule data of a transaction";
      description: "This endpoint exports the formatted travel rule data of a transaction if there are any.";
      tags: "Transactions";
    };
  };

}
