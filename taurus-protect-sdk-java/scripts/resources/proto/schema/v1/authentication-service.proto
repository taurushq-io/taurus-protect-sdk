syntax = "proto3";

package tgvalidatord;

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "protoc-gen-openapiv2/options/annotations.proto";

import "auth_proxy/api_request_to_validate.proto";
import "credentials.proto";
import "sso.proto";

option java_package = "com.taurushq.sdk.protect.proto.v1";

option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
  info: {
    title: "tg-validatord authentication service";
    description: "This service is responsible for authenticating users and returning authentication tokens";
    version: "1.0";
    contact: {
      name: "tg-validatord authentication service";
      url: "https://github.com/taurusgroup/tg-validatord";
      email: "development@taurusgroup.ch";
    };
  };
  schemes: [HTTP, HTTPS];
  consumes: "application/json";
  produces: "application/json";
  responses: {
    key: "404";
    value: {
      description: "Returned when the resource does not exist.";
    }
  };
  responses: {
    key: "403";
    value: {
      description: "Returned when the user is not authorized to access the resource.";
    }
  };
  responses: {
    key: "401";
    value: {
      description: "Returned when the user is not authenticated.";
    }
  };

};

message AuthenticationReply {
  string result = 1;
}

message StartLoginRequest {
  string email = 1;
}

message StartLoginReply {
  SecurityDomain.Mode result = 1;
}

message SAMLInitiateRequest {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      required: ["email", "redirect_uri"]
    }
  };

  string email = 1;
  string redirect_uri = 2;
}

message SAMLInitiateReply {
  SAMLAuthRequest result = 1;
}

message SAMLCheckAssertionRequest {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      required: ["SAMLResponse", "RelayState"]
    }
  };

  string SAMLResponse = 1;
  string RelayState = 2;
}

message SAMLCheckAssertionReply {
  SAMLAuthRedirect result = 1;
}

message SAMLSessionRequest {}

message SAMLSessionReply {
  SAMLSession result = 1;
}

message OIDCInitiateRequest {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      required: ["email", "redirect_uri"]
    }
  };

  string email = 1;
  string redirect_uri = 2;
}

message OIDCInitiateReply {
  OIDCLocation result = 1;
}

message OIDCSessionRequest {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      required: ["code", "state"]
    }
  };

  string code = 1;
  string state = 3;
}

message OIDCSessionReply {
  OIDCSession result = 1;
}

message ValidateAuthenticationReq {
  auth_proxy.ApiRequestToValidate apiRequestToValidate = 1 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "The HMAC signed request details that we need to validate";
    }
  ];
  bytes signature = 2 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "The signature of the protobuf-serialized ApiRequestToValidate message, that uses the shared JWT secret (through the REST API, the bytes are encoded as a base64 string)";
    }
  ];
}

message ValidateAuthenticationReply {
  string jwt = 1 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "A valid JWT for the user who made the original request";
    }
  ];
}

service AuthenticationService {

  rpc Authenticate(Credentials) returns (AuthenticationReply) {
    option (google.api.http) = {
      post: "/api/rest/v1/authentication/token"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get an authentication token";
      description: "This endpoint returns an authentication token";
      tags: "Authentication";
    };

  };

  rpc StartLogin(StartLoginRequest) returns (StartLoginReply) {
    option (google.api.http) = {
      post: "/api/rest/v1/authentication/start_login"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Start a login";
      description: "This endpoint determines the login mode to be used (Basic, OIDC, SAML)";
      tags: "Authentication";
    };
  };

  rpc SAMLInitiate(SAMLInitiateRequest) returns (SAMLInitiateReply) {
    option (google.api.http) = {
      post: "/api/rest/v1/authentication/saml/sso"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Initiate login";
      description: "This endpoint initiates a SAML login";
      tags: "Authentication: SAML";
    };
  };

  rpc SAMLCheckAssertion(SAMLCheckAssertionRequest) returns (SAMLCheckAssertionReply) {
    option (google.api.http) = {
      post: "/api/rest/v1/authentication/saml/acs"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Check assertion";
      description: "This endpoint checks the SAML assertion";
      tags: "Authentication: SAML";
    };
  }

  rpc SAMLSession(SAMLSessionRequest) returns (SAMLSessionReply) {
    option (google.api.http) = {
      post: "/api/rest/v1/authentication/saml/token"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get authentication token";
      description: "This endpoint returns an authentication token following a SAML login";
      tags: "Authentication: SAML";
    };
  };

  rpc OIDCInitiate(OIDCInitiateRequest) returns (OIDCInitiateReply) {
    option (google.api.http) = {
      post: "/api/rest/v1/authentication/oidc/sso"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Initiate login";
      description: "This endpoint initiates an OIDC login";
      tags: "Authentication: OIDC";
    };
  };

  rpc OIDCSession(OIDCSessionRequest) returns (OIDCSessionReply) {
    option (google.api.http) = {
      post: "/api/rest/v1/authentication/oidc/token"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get authentication token"
      description: "This endpoint returns an authentication token following an OIDC login";
      tags: "Authentication: OIDC";
    };
  };

  rpc ValidateAuthentication(ValidateAuthenticationReq) returns (ValidateAuthenticationReply) {
    option (google.api.http) = {
      post: "/api/rest/v1/userapikey/{apiRequestToValidate.apiKey}/authenticate"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Validate request"
      description: "This endpoint validates an HMAC signed request and sends back the user, if valid. We check that it comes from a client that share the jwt_secret with validatord";
      tags: "Authentication: HMAC";
    };
  };
}
