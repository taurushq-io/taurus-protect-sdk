package helper

import (
	"context"
	"testing"

	"github.com/pkg/errors"
	"github.com/stretchr/testify/mock"
	"github.com/stretchr/testify/require"
	"github.com/taurusgroup/tg-validatord/internal/bizerr"
	"github.com/taurusgroup/tg-validatord/internal/config"
	"github.com/taurusgroup/tg-validatord/internal/constants"

	rule_mocks "github.com/taurusgroup/tg-validatord/pkg/rule/mocks"
	"github.com/taurusgroup/tg-validatord/pkg/whitelist/model"
)

func TestHelper_VerifyWLContractAddressesIntegrity_TransientErrors(t *testing.T) {
	ctx := context.Background()
	ruler := &rule_mocks.Ruler{}

	tenantID := uint64(1)
	const rulesContainer = "CrsBCgExErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFeGE5S0V4SVBaSEUwcDJic2IrTEdNK05XTnk5VwpMdGRxbWJLOFMwaVlxL2VERDRUeFVSdGtadW14RFdBL2o5NTg1NnFTMFRZVzA3RVV3Qk56NU9Bby9RPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgIEAAq7AQoBMhKxAS0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRXhhOUtFeElQWkhFMHAyYnNiK0xHTStOV055OVcKTHRkcW1iSzhTMGlZcS9lREQ0VHhVUnRrWnVteERXQS9qOTU4NTZxUzBUWVcwN0VVd0JOejVPQW8vUT09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLRoCBAAKuwEKATMSsQEtLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLQpNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUV4YTlLRXhJUFpIRTBwMmJzYitMR00rTldOeTlXCkx0ZHFtYks4UzBpWXEvZURENFR4VVJ0a1p1bXhEV0Evajk1ODU2cVMwVFlXMDdFVXdCTno1T0FvL1E9PQotLS0tLUVORCBQVUJMSUMgS0VZLS0tLS0aAgQACswBChNoc21zbG90MUBzZWJhLnN3aXNzErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFMHFNbUs3bTlDQWtqYmVxZ3FXbWpVZzN2TUhyUgpTMDgybTM0ZjF2U3FVeWVpcWl3U25DSjk4R1FOekNoWDZxVlRFQU94T2w1WnBLeEk4T3ZWUTZ3Mm1RPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgEFCs8BChZzdXBlcmFkbWluMUBzZWJhLnN3aXNzErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFWHl2cVBVT3dWRWdLdzJ5Sm1TdG00Tk05ZVlnVQpyWmJSS0t6bVlqb083cWNYaFVpdVVxbDJQbDRZRWl2SVVmVXIrSUd2VjNTOGVwRi96KzNscytzNEJnPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgEDCs8BChZzdXBlcmFkbWluMkBzZWJhLnN3aXNzErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFNzU2SndhTGloSmZpU1ZtSi94RjdjSWJZTmF1SQpabWlReVBkWlpQWDRtUy9SQjdGcU8wWG0yalJVRnBzbEZxcHg1dDdrL1NzTkZYQlNPbG1ZOGREeEZBPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgEDCs8BChZzdXBlcmFkbWluM0BzZWJhLnN3aXNzErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFSzZLZHVCMllOMDlyamJGVzBxYmh3SkxBeVlSMQoxUEhIMHJGdEoxZm5TTWZtdzhPNHAycm9HWFRNOUd6R0FwS1l3ZWFmR3A3ZlZaRlhsOWEwVzlkU2F3PT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgEDCtEBChd1c2VyMS10ZW5hbnQxQGNoYW5nZS5tZRKxAS0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRXBDVEczTnl3MHBZY3VTcEdwbnVzTVU2OTY3bW8KM0Z3K3dPQkc0ZTRWVlFjcThVdnVDdkpkT1RmeHlVTndwNUEwMmFVeGpFWkhPc2ZQdFYvTEIxYllVZz09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLRoCBAAK0QEKF3VzZXIyLXRlbmFudDFAY2hhbmdlLm1lErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFcENURzNOeXcwcFljdVNwR3BudXNNVTY5NjdtbwozRncrd09CRzRlNFZWUWNxOFV2dUN2SmRPVGZ4eVVOd3A1QTAyYVV4akVaSE9zZlB0Vi9MQjFiWVVnPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgIEAArRAQoXdXNlcjMtdGVuYW50MUBjaGFuZ2UubWUSsQEtLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLQpNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUVwQ1RHM055dzBwWWN1U3BHcG51c01VNjk2N21vCjNGdyt3T0JHNGU0VlZRY3E4VXZ1Q3ZKZE9UZnh5VU53cDVBMDJhVXhqRVpIT3NmUHRWL0xCMWJZVWc9PQotLS0tLUVORCBQVUJMSUMgS0VZLS0tLS0aAgQACtkBCh12YWxpZGF0b3ItY29yZUB0YXVydXNncm91cC5jaBKzAS0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRWNIT0pQNUs4c1J3ZzFLeTFnQ2FQL2IyY3VacTQKS0NlMXh3cUhvSllEcU5wKzN1UUU0cXlteEkxUmVuY3Z1MWNhNGhYNWNhUXJhcjdQdjkrc21NYzdCdz09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQoKGgIBAhIjCgV0ZWFtMRIBMRIXdXNlcjEtdGVuYW50MUBjaGFuZ2UubWUSIwoFdGVhbTISATISF3VzZXIyLXRlbmFudDFAY2hhbmdlLm1lEiMKBXRlYW0zEgEzEhd1c2VyMy10ZW5hbnQxQGNoYW5nZS5tZSqXAQoDQkNIEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQaNwoACgAKDggCEgoKCDEwMC4wMDAwEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEaEwoACgAKABILCgkKBXRlYW0xEAEqlwEKA0JTVhIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50GjcKAAoACg4IAhIKCggxMDAuMDAwMBIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABGhMKAAoACgASCwoJCgV0ZWFtMRABKpcBCgNCVEMSEBIGc291cmNlGgZzb3VyY2USHAgBEgtkZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SEggCEgZhbW91bnQaBmFtb3VudBo3CgAKAAoOCAISCgoIMTAwLjAwMDASIQoJCgV0ZWFtMRABCgkKBXRlYW0yEAEKCQoFdGVhbTMQARoTCgAKAAoAEgsKCQoFdGVhbTEQASrMAQoDRVRDEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQSFAgDEgdwYXlsb2FkGgdwYXlsb2FkGjwKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoCCAEaLQoACgAKAAoCCAESIQoJCgV0ZWFtMRABCgkKBXRlYW0yEAEKCQoFdGVhbTMQASrMAQoDRVRIEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQSFAgDEgdwYXlsb2FkGgdwYXlsb2FkGjwKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoCCAEaLQoACgAKAAoCCAESIQoJCgV0ZWFtMRABCgkKBXRlYW0yEAEKCQoFdGVhbTMQASrAAQooRVRIL0VSQzIwX3RyYW5zZmVyX2ZpYXQoYWRkcmVzcyx1aW50MjU2KRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhYIARILZGVzdGluYXRpb24aBWFyZ18xEhEIAhIGYW1vdW50GgVhcmdfMhoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASqXAQoDTFRDEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQaNwoACgAKDggCEgoKCDEwMC4wMDAwEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEaEwoACgAKABILCgkKBXRlYW0xEAEqlwEKA05FTxIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50GjcKAAoACg4IAhIKCggxMDAuMDAwMBIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABGhMKAAoACgASCwoJCgV0ZWFtMRABKrwBCgNYTE0SEBIGc291cmNlGgZzb3VyY2USHAgBEgtkZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SEggCEgZhbW91bnQaBmFtb3VudBpGCgAKPggDEjoKOEdBTEFYWVZPSURBT1BaVERMSElMQUpRS0NWVkZNRDRJS0xYTFNaVjVZSE83Vlk3NElXWklMVVRPCgIIARopCgAKAAoAEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEqnwEKA1hSUBIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50GikKAAohCAMSHQobcnJycnJycnJycnJycnJycnJOQU1FdHh2TnZRCgIIARopCgAKAAoAEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEqqAEKA1hUWhIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50GjIKAAoqCAMSJgokdHoxS2UyaDdzRGRha0hKUWg4V1g0WjM3MmR1MUtDaHNrc3lVCgIIARopCgAKAAoAEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEqYQoMWFRaX0RlbGVnYXRlEhASBnNvdXJjZRoGc291cmNlEhYIARIIZGVsZWdhdGUaCGRlbGVnYXRlGicKAAoAEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEqYwoOWFRaX1VuZGVsZWdhdGUSEBIGc291cmNlGgZzb3VyY2USFggBEghkZWxlZ2F0ZRoIZGVsZWdhdGUaJwoACgASIQoJCgV0ZWFtMRABCgkKBXRlYW0yEAEKCQoFdGVhbTMQATIjEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAE6JRIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABGAU="
	const rulesSignature = "CloKFnN1cGVyYWRtaW4zQHNlYmEuc3dpc3MSQJtsY6TATOq/Fgl4HFaC3pZXmuVzrt8Ov6399CJabZIEqngk5eyg4VsF1uiXGc0Q1Zle30xBS9px4MYe8O+poT0KWgoWc3VwZXJhZG1pbjJAc2ViYS5zd2lzcxJASbW8IQTV0q8WMvUN/5C6dOktZZZexWEmPWafUNmyvwhv3LEaU2HHFNZQORvZE/ontdjjNCEebI8eydqU3GJEZg=="

	wlca := &model.WLContractAddress{
		RulesContainer:  rulesContainer,
		RulesSignatures: rulesSignature,
		Network:         "mainnet",
	}

	ruler.On("VerifySuperAdminsSignatures", ctx, tenantID, mock.Anything, mock.Anything).Return(errors.New("failed")).Once()

	err := VerifyWLContractAddressesIntegrity(ctx, tenantID, ruler, wlca, true, config.Blockchain{IncludeNetworkInPayload: false})
	require.Error(t, err)
	require.False(t, errors.Is(err, bizerr.InvalidWhitelistSignature)) // Transient ruler errors should not be InvalidSig

	ruler.On("VerifySuperAdminsSignatures", ctx, tenantID, mock.Anything, mock.Anything).Return(nil).Once()
	ruler.On("CheckWhitelistedContractAddress", ctx, tenantID, mock.Anything, mock.Anything, mock.Anything).Return(errors.New("failed")).Once()

	err = VerifyWLContractAddressesIntegrity(ctx, tenantID, ruler, wlca, true, config.Blockchain{IncludeNetworkInPayload: false})
	require.Error(t, err)
	require.False(t, errors.Is(err, bizerr.InvalidWhitelistSignature)) // Transient ruler errors should not be InvalidSig
}

func TestHelper_VerifyWLContractAddressesIntegrity_KnownErrors(t *testing.T) {
	ctx := context.Background()
	ruler := &rule_mocks.Ruler{}

	tenantID := uint64(1)
	const rulesContainer = "CrsBCgExErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFeGE5S0V4SVBaSEUwcDJic2IrTEdNK05XTnk5VwpMdGRxbWJLOFMwaVlxL2VERDRUeFVSdGtadW14RFdBL2o5NTg1NnFTMFRZVzA3RVV3Qk56NU9Bby9RPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgIEAAq7AQoBMhKxAS0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRXhhOUtFeElQWkhFMHAyYnNiK0xHTStOV055OVcKTHRkcW1iSzhTMGlZcS9lREQ0VHhVUnRrWnVteERXQS9qOTU4NTZxUzBUWVcwN0VVd0JOejVPQW8vUT09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLRoCBAAKuwEKATMSsQEtLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLQpNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUV4YTlLRXhJUFpIRTBwMmJzYitMR00rTldOeTlXCkx0ZHFtYks4UzBpWXEvZURENFR4VVJ0a1p1bXhEV0Evajk1ODU2cVMwVFlXMDdFVXdCTno1T0FvL1E9PQotLS0tLUVORCBQVUJMSUMgS0VZLS0tLS0aAgQACswBChNoc21zbG90MUBzZWJhLnN3aXNzErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFMHFNbUs3bTlDQWtqYmVxZ3FXbWpVZzN2TUhyUgpTMDgybTM0ZjF2U3FVeWVpcWl3U25DSjk4R1FOekNoWDZxVlRFQU94T2w1WnBLeEk4T3ZWUTZ3Mm1RPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgEFCs8BChZzdXBlcmFkbWluMUBzZWJhLnN3aXNzErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFWHl2cVBVT3dWRWdLdzJ5Sm1TdG00Tk05ZVlnVQpyWmJSS0t6bVlqb083cWNYaFVpdVVxbDJQbDRZRWl2SVVmVXIrSUd2VjNTOGVwRi96KzNscytzNEJnPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgEDCs8BChZzdXBlcmFkbWluMkBzZWJhLnN3aXNzErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFNzU2SndhTGloSmZpU1ZtSi94RjdjSWJZTmF1SQpabWlReVBkWlpQWDRtUy9SQjdGcU8wWG0yalJVRnBzbEZxcHg1dDdrL1NzTkZYQlNPbG1ZOGREeEZBPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgEDCs8BChZzdXBlcmFkbWluM0BzZWJhLnN3aXNzErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFSzZLZHVCMllOMDlyamJGVzBxYmh3SkxBeVlSMQoxUEhIMHJGdEoxZm5TTWZtdzhPNHAycm9HWFRNOUd6R0FwS1l3ZWFmR3A3ZlZaRlhsOWEwVzlkU2F3PT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgEDCtEBChd1c2VyMS10ZW5hbnQxQGNoYW5nZS5tZRKxAS0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRXBDVEczTnl3MHBZY3VTcEdwbnVzTVU2OTY3bW8KM0Z3K3dPQkc0ZTRWVlFjcThVdnVDdkpkT1RmeHlVTndwNUEwMmFVeGpFWkhPc2ZQdFYvTEIxYllVZz09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLRoCBAAK0QEKF3VzZXIyLXRlbmFudDFAY2hhbmdlLm1lErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFcENURzNOeXcwcFljdVNwR3BudXNNVTY5NjdtbwozRncrd09CRzRlNFZWUWNxOFV2dUN2SmRPVGZ4eVVOd3A1QTAyYVV4akVaSE9zZlB0Vi9MQjFiWVVnPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgIEAArRAQoXdXNlcjMtdGVuYW50MUBjaGFuZ2UubWUSsQEtLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLQpNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUVwQ1RHM055dzBwWWN1U3BHcG51c01VNjk2N21vCjNGdyt3T0JHNGU0VlZRY3E4VXZ1Q3ZKZE9UZnh5VU53cDVBMDJhVXhqRVpIT3NmUHRWL0xCMWJZVWc9PQotLS0tLUVORCBQVUJMSUMgS0VZLS0tLS0aAgQACtkBCh12YWxpZGF0b3ItY29yZUB0YXVydXNncm91cC5jaBKzAS0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRWNIT0pQNUs4c1J3ZzFLeTFnQ2FQL2IyY3VacTQKS0NlMXh3cUhvSllEcU5wKzN1UUU0cXlteEkxUmVuY3Z1MWNhNGhYNWNhUXJhcjdQdjkrc21NYzdCdz09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQoKGgIBAhIjCgV0ZWFtMRIBMRIXdXNlcjEtdGVuYW50MUBjaGFuZ2UubWUSIwoFdGVhbTISATISF3VzZXIyLXRlbmFudDFAY2hhbmdlLm1lEiMKBXRlYW0zEgEzEhd1c2VyMy10ZW5hbnQxQGNoYW5nZS5tZSqXAQoDQkNIEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQaNwoACgAKDggCEgoKCDEwMC4wMDAwEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEaEwoACgAKABILCgkKBXRlYW0xEAEqlwEKA0JTVhIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50GjcKAAoACg4IAhIKCggxMDAuMDAwMBIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABGhMKAAoACgASCwoJCgV0ZWFtMRABKpcBCgNCVEMSEBIGc291cmNlGgZzb3VyY2USHAgBEgtkZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SEggCEgZhbW91bnQaBmFtb3VudBo3CgAKAAoOCAISCgoIMTAwLjAwMDASIQoJCgV0ZWFtMRABCgkKBXRlYW0yEAEKCQoFdGVhbTMQARoTCgAKAAoAEgsKCQoFdGVhbTEQASrMAQoDRVRDEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQSFAgDEgdwYXlsb2FkGgdwYXlsb2FkGjwKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoCCAEaLQoACgAKAAoCCAESIQoJCgV0ZWFtMRABCgkKBXRlYW0yEAEKCQoFdGVhbTMQASrMAQoDRVRIEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQSFAgDEgdwYXlsb2FkGgdwYXlsb2FkGjwKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoCCAEaLQoACgAKAAoCCAESIQoJCgV0ZWFtMRABCgkKBXRlYW0yEAEKCQoFdGVhbTMQASrAAQooRVRIL0VSQzIwX3RyYW5zZmVyX2ZpYXQoYWRkcmVzcyx1aW50MjU2KRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhYIARILZGVzdGluYXRpb24aBWFyZ18xEhEIAhIGYW1vdW50GgVhcmdfMhoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASqXAQoDTFRDEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQaNwoACgAKDggCEgoKCDEwMC4wMDAwEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEaEwoACgAKABILCgkKBXRlYW0xEAEqlwEKA05FTxIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50GjcKAAoACg4IAhIKCggxMDAuMDAwMBIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABGhMKAAoACgASCwoJCgV0ZWFtMRABKrwBCgNYTE0SEBIGc291cmNlGgZzb3VyY2USHAgBEgtkZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SEggCEgZhbW91bnQaBmFtb3VudBpGCgAKPggDEjoKOEdBTEFYWVZPSURBT1BaVERMSElMQUpRS0NWVkZNRDRJS0xYTFNaVjVZSE83Vlk3NElXWklMVVRPCgIIARopCgAKAAoAEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEqnwEKA1hSUBIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50GikKAAohCAMSHQobcnJycnJycnJycnJycnJycnJOQU1FdHh2TnZRCgIIARopCgAKAAoAEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEqqAEKA1hUWhIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50GjIKAAoqCAMSJgokdHoxS2UyaDdzRGRha0hKUWg4V1g0WjM3MmR1MUtDaHNrc3lVCgIIARopCgAKAAoAEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEqYQoMWFRaX0RlbGVnYXRlEhASBnNvdXJjZRoGc291cmNlEhYIARIIZGVsZWdhdGUaCGRlbGVnYXRlGicKAAoAEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEqYwoOWFRaX1VuZGVsZWdhdGUSEBIGc291cmNlGgZzb3VyY2USFggBEghkZWxlZ2F0ZRoIZGVsZWdhdGUaJwoACgASIQoJCgV0ZWFtMRABCgkKBXRlYW0yEAEKCQoFdGVhbTMQATIjEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAE6JRIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABGAU="
	const rulesSignature = "CloKFnN1cGVyYWRtaW4zQHNlYmEuc3dpc3MSQJtsY6TATOq/Fgl4HFaC3pZXmuVzrt8Ov6399CJabZIEqngk5eyg4VsF1uiXGc0Q1Zle30xBS9px4MYe8O+poT0KWgoWc3VwZXJhZG1pbjJAc2ViYS5zd2lzcxJASbW8IQTV0q8WMvUN/5C6dOktZZZexWEmPWafUNmyvwhv3LEaU2HHFNZQORvZE/ontdjjNCEebI8eydqU3GJEZg=="

	wlca := &model.WLContractAddress{
		RulesContainer:  rulesContainer,
		RulesSignatures: rulesSignature,
		Network:         "mainnet",
	}

	ruler.On("VerifySuperAdminsSignatures", ctx, tenantID, mock.Anything, mock.Anything).Return(bizerr.NoMinRequiredSigThreshold).Once()

	err := VerifyWLContractAddressesIntegrity(ctx, tenantID, ruler, wlca, true, config.Blockchain{IncludeNetworkInPayload: false})
	require.Error(t, err)
	require.True(t, errors.Is(err, bizerr.InvalidSuperadminRulesSignature)) // Some known ruler errors should be invalid sig

	ruler.On("VerifySuperAdminsSignatures", ctx, tenantID, mock.Anything, mock.Anything).Return(bizerr.NotEnoughRulesSignatures).Once()

	err = VerifyWLContractAddressesIntegrity(ctx, tenantID, ruler, wlca, true, config.Blockchain{IncludeNetworkInPayload: false})
	require.Error(t, err)
	require.True(t, errors.Is(err, bizerr.InvalidSuperadminRulesSignature)) // Some known ruler errors should be invalid sig

	ruler.On("VerifySuperAdminsSignatures", ctx, tenantID, mock.Anything, mock.Anything).Return(nil).Once()
	ruler.On("CheckWhitelistedContractAddress", ctx, tenantID, mock.Anything, mock.Anything, mock.Anything).Return(bizerr.EntityNotFullySigned).Once()

	err = VerifyWLContractAddressesIntegrity(ctx, tenantID, ruler, wlca, true, config.Blockchain{IncludeNetworkInPayload: false})
	require.Error(t, err)
	require.True(t, errors.Is(err, bizerr.InvalidWhitelistSignature)) // Some known ruler errors should be invalid sig
}

func TestHelper_VerifyWLContractAddressesIntegrity_InvalidDBFieldSigFields(t *testing.T) {
	ctx := context.Background()
	ruler := &rule_mocks.Ruler{}

	tenantID := uint64(1)
	const env = "CtkDCksKATESQM142KiUqmWSgotUB+x7AjtYKkeVAVfFOsKVaHV40dttvUkznU47CcDVhizN9BYbIqWvjduddVCIRh3pfESQxSYaBGFhYWESQDNkNjVmNDFmNmEwMTcxZmFhNmE0N2VhNTgxNzRiZDA2MjRkODc3OTc0MzE5NDJhMGVlMTk5NWMyMjNlNWJmZmESQDFkMDE0MDliYWVhOTBhYTg0MDBiZGE1MWI5MDFjZjU1MTEzN2IzYzMxNGI5Y2QxNmFkNGNjZDQyODA2MDQwMTISQDcyZWU1NzFhY2E0YWY5N2U3YzlmN2Q4N2E4MzM2NjYyNmY0ZGU2YWNlOGU1OWE5MTY2YjQ1YjIwNTg2YWE0ZDESQDNjMjM4MzZkNzJkZjcwZTM5MTc3ZjM3OGQ0MWUxZDQ1M2YxOTMzY2M5ZDU2MmJkNGQxNTY5MGY4N2FlMmU5YzUSQDEzZTNlZTkzMzY2YmRiMzE2ZGY1OTliZmE0NTg0NGIyMWNhYzU2Mzk5OWU0NjdmZWVkYTJkZmQ4ZjdlZThmNDgSQDEwMzlhMThjMmRlYjI1N2ZhYTZhYjEwYmEyMDU4MWMwNmU5MjMzZGUzZjBjZTYyNzllNDY3ZTAyOTRhYzJmY2UK2AMKSgoBMhJAHoHCgZCQG7FF/QrJQrdo/D8b/+pe4/xkEP/6AqegVBR6R/4P/i6S2G+StpMZguNNH6I8Dpr2y/hHw6qZLgyt9hoDeHh4EkAzZDY1ZjQxZjZhMDE3MWZhYTZhNDdlYTU4MTc0YmQwNjI0ZDg3Nzk3NDMxOTQyYTBlZTE5OTVjMjIzZTViZmZhEkAxZDAxNDA5YmFlYTkwYWE4NDAwYmRhNTFiOTAxY2Y1NTExMzdiM2MzMTRiOWNkMTZhZDRjY2Q0MjgwNjA0MDEyEkA3MmVlNTcxYWNhNGFmOTdlN2M5ZjdkODdhODMzNjY2MjZmNGRlNmFjZThlNTlhOTE2NmI0NWIyMDU4NmFhNGQxEkAzYzIzODM2ZDcyZGY3MGUzOTE3N2YzNzhkNDFlMWQ0NTNmMTkzM2NjOWQ1NjJiZDRkMTU2OTBmODdhZTJlOWM1EkAxM2UzZWU5MzM2NmJkYjMxNmRmNTk5YmZhNDU4NDRiMjFjYWM1NjM5OTllNDY3ZmVlZGEyZGZkOGY3ZWU4ZjQ4EkAxMDM5YTE4YzJkZWIyNTdmYWE2YWIxMGJhMjA1ODFjMDZlOTIzM2RlM2YwY2U2Mjc5ZTQ2N2UwMjk0YWMyZmNlCtoDCkwKATMSQIZdIzglVTGg1bo7JShFnps5RSjiYFouaKKUSi2oGRJtI6UlDscvKVPYxOK4cDJ0UJ/pxe6fn4vFVW7iwKYr9GAaBXZ2dnZ2EkAzZDY1ZjQxZjZhMDE3MWZhYTZhNDdlYTU4MTc0YmQwNjI0ZDg3Nzk3NDMxOTQyYTBlZTE5OTVjMjIzZTViZmZhEkAxZDAxNDA5YmFlYTkwYWE4NDAwYmRhNTFiOTAxY2Y1NTExMzdiM2MzMTRiOWNkMTZhZDRjY2Q0MjgwNjA0MDEyEkA3MmVlNTcxYWNhNGFmOTdlN2M5ZjdkODdhODMzNjY2MjZmNGRlNmFjZThlNTlhOTE2NmI0NWIyMDU4NmFhNGQxEkAzYzIzODM2ZDcyZGY3MGUzOTE3N2YzNzhkNDFlMWQ0NTNmMTkzM2NjOWQ1NjJiZDRkMTU2OTBmODdhZTJlOWM1EkAxM2UzZWU5MzM2NmJkYjMxNmRmNTk5YmZhNDU4NDRiMjFjYWM1NjM5OTllNDY3ZmVlZGEyZGZkOGY3ZWU4ZjQ4EkAxMDM5YTE4YzJkZWIyNTdmYWE2YWIxMGJhMjA1ODFjMDZlOTIzM2RlM2YwY2U2Mjc5ZTQ2N2UwMjk0YWMyZmNlEj0KA0VUSBIDQUFBGgNBQUEgEioqMHhiZTFkODIwNDg5ZmViNjY5MjcyMjA0MWQ5Zjc4NDI2M2E4NTdhYWFi"
	const rulesContainer = "CrsBCgExErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFeGE5S0V4SVBaSEUwcDJic2IrTEdNK05XTnk5VwpMdGRxbWJLOFMwaVlxL2VERDRUeFVSdGtadW14RFdBL2o5NTg1NnFTMFRZVzA3RVV3Qk56NU9Bby9RPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgIEAAq7AQoBMhKxAS0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRXhhOUtFeElQWkhFMHAyYnNiK0xHTStOV055OVcKTHRkcW1iSzhTMGlZcS9lREQ0VHhVUnRrWnVteERXQS9qOTU4NTZxUzBUWVcwN0VVd0JOejVPQW8vUT09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLRoCBAAKuwEKATMSsQEtLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLQpNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUV4YTlLRXhJUFpIRTBwMmJzYitMR00rTldOeTlXCkx0ZHFtYks4UzBpWXEvZURENFR4VVJ0a1p1bXhEV0Evajk1ODU2cVMwVFlXMDdFVXdCTno1T0FvL1E9PQotLS0tLUVORCBQVUJMSUMgS0VZLS0tLS0aAgQACswBChNoc21zbG90MUBzZWJhLnN3aXNzErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFMHFNbUs3bTlDQWtqYmVxZ3FXbWpVZzN2TUhyUgpTMDgybTM0ZjF2U3FVeWVpcWl3U25DSjk4R1FOekNoWDZxVlRFQU94T2w1WnBLeEk4T3ZWUTZ3Mm1RPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgEFCs8BChZzdXBlcmFkbWluMUBzZWJhLnN3aXNzErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFWHl2cVBVT3dWRWdLdzJ5Sm1TdG00Tk05ZVlnVQpyWmJSS0t6bVlqb083cWNYaFVpdVVxbDJQbDRZRWl2SVVmVXIrSUd2VjNTOGVwRi96KzNscytzNEJnPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgEDCs8BChZzdXBlcmFkbWluMkBzZWJhLnN3aXNzErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFNzU2SndhTGloSmZpU1ZtSi94RjdjSWJZTmF1SQpabWlReVBkWlpQWDRtUy9SQjdGcU8wWG0yalJVRnBzbEZxcHg1dDdrL1NzTkZYQlNPbG1ZOGREeEZBPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgEDCs8BChZzdXBlcmFkbWluM0BzZWJhLnN3aXNzErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFSzZLZHVCMllOMDlyamJGVzBxYmh3SkxBeVlSMQoxUEhIMHJGdEoxZm5TTWZtdzhPNHAycm9HWFRNOUd6R0FwS1l3ZWFmR3A3ZlZaRlhsOWEwVzlkU2F3PT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgEDCtEBChd1c2VyMS10ZW5hbnQxQGNoYW5nZS5tZRKxAS0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRXBDVEczTnl3MHBZY3VTcEdwbnVzTVU2OTY3bW8KM0Z3K3dPQkc0ZTRWVlFjcThVdnVDdkpkT1RmeHlVTndwNUEwMmFVeGpFWkhPc2ZQdFYvTEIxYllVZz09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLRoCBAAK0QEKF3VzZXIyLXRlbmFudDFAY2hhbmdlLm1lErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFcENURzNOeXcwcFljdVNwR3BudXNNVTY5NjdtbwozRncrd09CRzRlNFZWUWNxOFV2dUN2SmRPVGZ4eVVOd3A1QTAyYVV4akVaSE9zZlB0Vi9MQjFiWVVnPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgIEAArRAQoXdXNlcjMtdGVuYW50MUBjaGFuZ2UubWUSsQEtLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLQpNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUVwQ1RHM055dzBwWWN1U3BHcG51c01VNjk2N21vCjNGdyt3T0JHNGU0VlZRY3E4VXZ1Q3ZKZE9UZnh5VU53cDVBMDJhVXhqRVpIT3NmUHRWL0xCMWJZVWc9PQotLS0tLUVORCBQVUJMSUMgS0VZLS0tLS0aAgQACtkBCh12YWxpZGF0b3ItY29yZUB0YXVydXNncm91cC5jaBKzAS0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRWNIT0pQNUs4c1J3ZzFLeTFnQ2FQL2IyY3VacTQKS0NlMXh3cUhvSllEcU5wKzN1UUU0cXlteEkxUmVuY3Z1MWNhNGhYNWNhUXJhcjdQdjkrc21NYzdCdz09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQoKGgIBAhIjCgV0ZWFtMRIBMRIXdXNlcjEtdGVuYW50MUBjaGFuZ2UubWUSIwoFdGVhbTISATISF3VzZXIyLXRlbmFudDFAY2hhbmdlLm1lEiMKBXRlYW0zEgEzEhd1c2VyMy10ZW5hbnQxQGNoYW5nZS5tZSqXAQoDQkNIEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQaNwoACgAKDggCEgoKCDEwMC4wMDAwEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEaEwoACgAKABILCgkKBXRlYW0xEAEqlwEKA0JTVhIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50GjcKAAoACg4IAhIKCggxMDAuMDAwMBIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABGhMKAAoACgASCwoJCgV0ZWFtMRABKpcBCgNCVEMSEBIGc291cmNlGgZzb3VyY2USHAgBEgtkZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SEggCEgZhbW91bnQaBmFtb3VudBo3CgAKAAoOCAISCgoIMTAwLjAwMDASIQoJCgV0ZWFtMRABCgkKBXRlYW0yEAEKCQoFdGVhbTMQARoTCgAKAAoAEgsKCQoFdGVhbTEQASrMAQoDRVRDEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQSFAgDEgdwYXlsb2FkGgdwYXlsb2FkGjwKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoCCAEaLQoACgAKAAoCCAESIQoJCgV0ZWFtMRABCgkKBXRlYW0yEAEKCQoFdGVhbTMQASrMAQoDRVRIEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQSFAgDEgdwYXlsb2FkGgdwYXlsb2FkGjwKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoCCAEaLQoACgAKAAoCCAESIQoJCgV0ZWFtMRABCgkKBXRlYW0yEAEKCQoFdGVhbTMQASrAAQooRVRIL0VSQzIwX3RyYW5zZmVyX2ZpYXQoYWRkcmVzcyx1aW50MjU2KRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhYIARILZGVzdGluYXRpb24aBWFyZ18xEhEIAhIGYW1vdW50GgVhcmdfMhoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASqXAQoDTFRDEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQaNwoACgAKDggCEgoKCDEwMC4wMDAwEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEaEwoACgAKABILCgkKBXRlYW0xEAEqlwEKA05FTxIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50GjcKAAoACg4IAhIKCggxMDAuMDAwMBIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABGhMKAAoACgASCwoJCgV0ZWFtMRABKrwBCgNYTE0SEBIGc291cmNlGgZzb3VyY2USHAgBEgtkZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SEggCEgZhbW91bnQaBmFtb3VudBpGCgAKPggDEjoKOEdBTEFYWVZPSURBT1BaVERMSElMQUpRS0NWVkZNRDRJS0xYTFNaVjVZSE83Vlk3NElXWklMVVRPCgIIARopCgAKAAoAEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEqnwEKA1hSUBIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50GikKAAohCAMSHQobcnJycnJycnJycnJycnJycnJOQU1FdHh2TnZRCgIIARopCgAKAAoAEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEqqAEKA1hUWhIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50GjIKAAoqCAMSJgokdHoxS2UyaDdzRGRha0hKUWg4V1g0WjM3MmR1MUtDaHNrc3lVCgIIARopCgAKAAoAEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEqYQoMWFRaX0RlbGVnYXRlEhASBnNvdXJjZRoGc291cmNlEhYIARIIZGVsZWdhdGUaCGRlbGVnYXRlGicKAAoAEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEqYwoOWFRaX1VuZGVsZWdhdGUSEBIGc291cmNlGgZzb3VyY2USFggBEghkZWxlZ2F0ZRoIZGVsZWdhdGUaJwoACgASIQoJCgV0ZWFtMRABCgkKBXRlYW0yEAEKCQoFdGVhbTMQATIjEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAE6JRIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABGAU="
	const rulesSignature = "CloKFnN1cGVyYWRtaW4zQHNlYmEuc3dpc3MSQJtsY6TATOq/Fgl4HFaC3pZXmuVzrt8Ov6399CJabZIEqngk5eyg4VsF1uiXGc0Q1Zle30xBS9px4MYe8O+poT0KWgoWc3VwZXJhZG1pbjJAc2ViYS5zd2lzcxJASbW8IQTV0q8WMvUN/5C6dOktZZZexWEmPWafUNmyvwhv3LEaU2HHFNZQORvZE/ontdjjNCEebI8eydqU3GJEZg=="

	_, wlc, err := DecodeSignedWhitelistedContractAddress(env)
	require.NoError(t, err)

	// Empty wlca with good filled envelope (no fields match)
	wlca := &model.WLContractAddress{
		Envelope:        env, // ETH, AAA, AAA, 18, 0xbe1d820489feb6692722041d9f784263a857aaab
		RulesContainer:  rulesContainer,
		RulesSignatures: rulesSignature,
		Network:         "mainnet",
	}

	ruler.On("VerifySuperAdminsSignatures", ctx, tenantID, mock.Anything, mock.Anything).Return(nil).Times(5)
	ruler.On("CheckWhitelistedContractAddress", ctx, tenantID, mock.Anything, mock.Anything, mock.Anything).Return(nil).Times(5)

	// Invalid blockchain
	err = VerifyWLContractAddressesIntegrity(ctx, tenantID, ruler, wlca, true, config.Blockchain{IncludeNetworkInPayload: false})
	require.Error(t, err)
	require.True(t, errors.Is(err, bizerr.InvalidWhitelistSignature))
	require.Contains(t, err.Error(), "field Blockchain")

	// Invalid name
	wlca.Blockchain = constants.ToBlockchainSymbol(wlc.GetBlockchain())
	err = VerifyWLContractAddressesIntegrity(ctx, tenantID, ruler, wlca, true, config.Blockchain{IncludeNetworkInPayload: false})
	require.Error(t, err)
	require.True(t, errors.Is(err, bizerr.InvalidWhitelistSignature))
	require.Contains(t, err.Error(), "field Name")

	// Invalid decimals
	wlca.Name = wlc.GetName()
	err = VerifyWLContractAddressesIntegrity(ctx, tenantID, ruler, wlca, true, config.Blockchain{IncludeNetworkInPayload: false})
	require.Error(t, err)
	require.True(t, errors.Is(err, bizerr.InvalidWhitelistSignature))
	require.Contains(t, err.Error(), "field Decimals")

	// Invalid symbol
	wlca.Decimals = wlc.GetDecimals()
	err = VerifyWLContractAddressesIntegrity(ctx, tenantID, ruler, wlca, true, config.Blockchain{IncludeNetworkInPayload: false})
	require.Error(t, err)
	require.True(t, errors.Is(err, bizerr.InvalidWhitelistSignature))
	require.Contains(t, err.Error(), "field Symbol")

	// Invalid contract address
	wlca.Symbol = wlc.GetSymbol()
	err = VerifyWLContractAddressesIntegrity(ctx, tenantID, ruler, wlca, true, config.Blockchain{IncludeNetworkInPayload: false})
	require.Error(t, err)
	require.True(t, errors.Is(err, bizerr.InvalidWhitelistSignature))
	require.Contains(t, err.Error(), "field ContractAddress")
}

func TestHelper_VerifyWLAddressesIntegrity_TransientErrors(t *testing.T) {
	ctx := context.Background()
	ruler := &rule_mocks.Ruler{}

	tenantID := uint64(1)
	const rulesContainer = "CtABChdoc21zbG90MEB0YXVydXNncm91cC5jaBKxAS0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRXFZWUIyN2xVVmZSeG5KWUMvWng3VTJIamR3OUkKZHg2VW53dytQNG4xNUE1U1R6RVpEQmFYSSs3MTNzRXArUTEzQkQyalluSkJzSmdpbjJINDk2SUk3QT09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLRoBBQrOAQoUc3VwZXJhZG1pbjFAYmFuay5jb20SsgEtLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLQpNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUVNMk50emFGaG03eElSM092V3E1Y2hXMy9HRXZXCkwrM3Vxb0U2bEVKMTNlV2J1bHhzUC81aDM2VkNxWURJR04vMHdEZVd3TFlkcHU1SGhTWFdoeENzQ0E9PQotLS0tLUVORCBQVUJMSUMgS0VZLS0tLS0KGgEDCs4BChRzdXBlcmFkbWluMkBiYW5rLmNvbRKyAS0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRVk5ekd1Z3pOTElmcFp1YVVyenl3RWgvOFpkdFgKNElJdUlwREhMdkozNmdsRmpmeHhTWmRPRzZ5SEtGRmxRaDFHWDNPQ0ZaeEhlK3hlT0dCSkhCZ3JhQT09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQoaAQMKzgEKFHN1cGVyYWRtaW4zQGJhbmsuY29tErIBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFVjJ6RUR2WmpKL3FSK1FoMXIwc0tOY2kzOXc3OQpCMDBOZzVNR2c0d1JNN0FoOXByMUdia2dyS0lVZjRrYUhQanJQVmFRS0lSOHpEVTNqZ20wbFd4ZUhBPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tChoBAwrIAQoOdGVhbTFAYmFuay5jb20SsQEtLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLQpNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUV2N2FWLzcvaTNqOUVocTBOOHJrTkF3c0hCdVNwCnVRYWJpa2JaclQrZUFDSUFPeUo2bnVzVm9RbzA5YU9zV3FRbUkzNUJRU3ZaUXNld092a05sWEZtMGc9PQotLS0tLUVORCBQVUJMSUMgS0VZLS0tLS0aAgQACscBCg50ZWFtMkBiYW5rLmNvbRKxAS0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRTRVQW8rR054dzR0RXFkbVREaTZ2Mk1acTJ1ZzgKYWpXOC9NbnFKL1FkNGJuaVB5RHZJVHJTRVpVeVA5VHZZcGtMQWJnL0FDeGNSL3lBNmxCRWd0RTYwUT09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLRoBAArHAQoOdGVhbTNAYmFuay5jb20SsQEtLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLQpNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUVIaml3VThDd3hQUEYrU3hiVFZPbTdaMW5kOVA2Cm1UYkZDMkZZVVlpU2xBSndmRTd3b003QkFPZzZiOFcweTBKSUpBYyt0MTZWN3pPTVd6c0ZWbWVlNmc9PQotLS0tLUVORCBQVUJMSUMgS0VZLS0tLS0aAQAK1gEKHXZhbGlkYXRvci1jb3JlQHRhdXJ1c2dyb3VwLmNoErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFWVBYSUI0bXRxeTBBTHVFS2RZQWZRcFdtc0t1NgpEbTVhMDVkY1JVRlc1MkpHazBNNzdlc2FvSHNpSHVHODlxRnF5ZkZJLzJQZjRTL2hMbkhCR1dNbVJnPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgEBEjUKFF9fdGF1cnVzX3RlY2huaWNhbF9fEh12YWxpZGF0b3ItY29yZUB0YXVydXNncm91cC5jaBIfCg1maXJzdF9saW5lX0FEEg50ZWFtMUBiYW5rLmNvbRIgCg5zZWNvbmRfbGluZV9BRBIOdGVhbTJAYmFuay5jb20SFwoFdGVhbTESDnRlYW0xQGJhbmsuY29tEhcKBXRlYW0yEg50ZWFtMkBiYW5rLmNvbRIXCgV0ZWFtMxIOdGVhbTNAYmFuay5jb20SHwoNdGhpcmRfbGluZV9BRBIOdGVhbTNAYmFuay5jb20qXgoDQkNIEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQaEwoACgAKABILCgkKBXRlYW0xEAEqXgoDQlRDEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQaEwoACgAKABILCgkKBXRlYW0xEAEqYQoIRGllbS9YVVMSCBIGc291cmNlEg8IARILZGVzdGluYXRpb24SCggCEgZhbW91bnQaLgoACiYIAxIiCiAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMAoCCAEqJQoNRGllbS9YVVNfQnVybhIIEgZzb3VyY2USCggCEgZhbW91bnQqJQoNRGllbS9YVVNfTWludBIIEgZzb3VyY2USCggCEgZhbW91bnQqtgEKA0VUQxIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50EhQIAxIHcGF5bG9hZBoHcGF5bG9hZBo8CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKAggBGhcKAAoACgAKAggBEgsKCQoFdGVhbTEQASq2AQoDRVRIEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQSFAgDEgdwYXlsb2FkGgdwYXlsb2FkGjwKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoCCAEaFwoACgAKAAoCCAESCwoJCgV0ZWFtMRABKocCCjBFVEgvQ01UQTIwLUtZQ192YWxpZGF0ZUtZQ1VudGlsKGFkZHJlc3MsdWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBITCAQSCF9hZGRyZXNzGgVhcmdfMRIVCAYSCl90aW1lc3RhbXAaBWFyZ18yGjwKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoACgAaGQoACgAKAggBCgAKABILCgkKBXRlYW0xEAEqjwIKNkVUSC9DTVRBMjAtS1lDX3ZhbGlkYXRlTWFueUtZQ1VudGlsKGFkZHJlc3NbXSx1aW50MjU2KRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhUIBxIKX2FkZHJlc3NlcxoFYXJnXzESFQgGEgpfdGltZXN0YW1wGgVhcmdfMho8CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKAAoAGhkKAAoACgIIAQoACgASCwoJCgV0ZWFtMRABKuIBCilFVEgvQ01UQTIwLVJVTEVFTkdJTkVfc2V0UnVsZXMoYWRkcmVzc1tdKRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhAIBxIFcnVsZXMaBWFyZ18xGjoKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoAGhcKAAoACgIIAQoAEgsKCQoFdGVhbTEQASr2AQojRVRIL0NNVEEyMF9hcHByb3ZlKGFkZHJlc3MsdWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBITCAQSCF9zcGVuZGVyGgVhcmdfMRIRCAYSBl92YWx1ZRoFYXJnXzIaPAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAKABoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASqKAgotRVRIL0NNVEEyMF9kZWNyZWFzZUFsbG93YW5jZShhZGRyZXNzLHVpbnQyNTYpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQSEwgEEghfc3BlbmRlchoFYXJnXzESGwgGEhBfc3VidHJhY3RlZFZhbHVlGgVhcmdfMho8CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKAAoAGhkKAAoACgIIAQoACgASCwoJCgV0ZWFtMRABKt0BCh1FVEgvQ01UQTIwX2Rlc3Ryb3koYWRkcmVzc1tdKRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhcIBxIMc2hhcmVob2xkZXJzGgVhcmdfMRo6CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKABoXCgAKAAoCCAEKABILCgkKBXRlYW0xEAEqhQIKLUVUSC9DTVRBMjBfaW5jcmVhc2VBbGxvd2FuY2UoYWRkcmVzcyx1aW50MjU2KRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhMIBBIIX3NwZW5kZXIaBWFyZ18xEhYIBhILX2FkZGVkVmFsdWUaBWFyZ18yGjwKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoACgAaGQoACgAKAggBCgAKABILCgkKBXRlYW0xEAEq0wEKGUVUSC9DTVRBMjBfaXNzdWUodWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBIRCAYSBl92YWx1ZRoFYXJnXzEaOgoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAaFwoACgAKAggBCgASCwoJCgV0ZWFtMRABKrUBChJFVEgvQ01UQTIwX3BhdXNlKCkSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBo4CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEaFQoACgAKAggBEgsKCQoFdGVhbTEQASr8AQokRVRIL0NNVEEyMF9yZWFzc2lnbihhZGRyZXNzLGFkZHJlc3MpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQSEwgEEghvcmlnaW5hbBoFYXJnXzESFggEEgtyZXBsYWNlbWVudBoFYXJnXzIaPAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAKABoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASrUAQoaRVRIL0NNVEEyMF9yZWRlZW0odWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBIRCAYSBl92YWx1ZRoFYXJnXzEaOgoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAaFwoACgAKAggBCgASCwoJCgV0ZWFtMRABKsEBCh5FVEgvQ01UQTIwX3Jlbm91bmNlT3duZXJzaGlwKCkSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBo4CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEaFQoACgAKAggBEgsKCQoFdGVhbTEQASrZAQodRVRIL0NNVEEyMF9zZXRDb250YWN0KHN0cmluZykSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBITCAQSCF9jb250YWN0GgVhcmdfMRo6CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKABoXCgAKAAoCCAEKABILCgkKBXRlYW0xEAEq3AEKH0VUSC9DTVRBMjBfc2V0TXlJZGVudGl0eShieXRlcykSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBIUCAMSCV9pZGVudGl0eRoFYXJnXzEaOgoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAaFwoACgAKAggBCgASCwoJCgV0ZWFtMRABKuABCiFFVEgvQ01UQTIwX3NldFJ1bGVFbmdpbmUoYWRkcmVzcykSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBIWCAQSC19ydWxlRW5naW5lGgVhcmdfMRo6CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKABoXCgAKAAoCCAEKABILCgkKBXRlYW0xEAEq8gEKJEVUSC9DTVRBMjBfdHJhbnNmZXIoYWRkcmVzcyx1aW50MjU2KRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50Eg4IBBIDX3RvGgVhcmdfMRIRCAYSBl92YWx1ZRoFYXJnXzIaPAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAKABoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASqUAgowRVRIL0NNVEEyMF90cmFuc2ZlckZyb20oYWRkcmVzcyxhZGRyZXNzLHVpbnQyNTYpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQSEAgEEgVfZnJvbRoFYXJnXzESDggEEgNfdG8aBWFyZ18yEhEIBhIGX3ZhbHVlGgVhcmdfMxo+CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKAAoACgAaGwoACgAKAggBCgAKAAoAEgsKCQoFdGVhbTEQASriAQolRVRIL0NNVEEyMF90cmFuc2Zlck93bmVyc2hpcChhZGRyZXNzKRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhQIBBIJX25ld093bmVyGgVhcmdfMRo6CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKABoXCgAKAAoCCAEKABILCgkKBXRlYW0xEAEqtwEKFEVUSC9DTVRBMjBfdW5wYXVzZSgpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQaOAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBGhUKAAoACgIIARILCgkKBXRlYW0xEAEq9AEKIkVUSC9FUkMyMF9hcHByb3ZlKGFkZHJlc3MsdWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBISCAQSB3NwZW5kZXIaBWFyZ18xEhEIBhIGYW1vdW50GgVhcmdfMho8CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKAAoAGhkKAAoACgIIAQoACgASCwoJCgV0ZWFtMRABKvEBCh9FVEgvRVJDMjBfYnVybihhZGRyZXNzLHVpbnQyNTYpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQSEggEEgdhY2NvdW50GgVhcmdfMRIRCAYSBmFtb3VudBoFYXJnXzIaPAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAKABoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASqIAgosRVRIL0VSQzIwX2RlY3JlYXNlQWxsb3dhbmNlKGFkZHJlc3MsdWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBITCAQSCF9zcGVuZGVyGgVhcmdfMRIaCAYSD3N1YnRyYWN0ZWRWYWx1ZRoFYXJnXzIaPAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAKABoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASqCAgosRVRIL0VSQzIwX2luY3JlYXNlQWxsb3dhbmNlKGFkZHJlc3MsdWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBISCAQSB3NwZW5kZXIaBWFyZ18xEhUIBhIKYWRkZWRWYWx1ZRoFYXJnXzIaPAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAKABoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASrxAQofRVRIL0VSQzIwX21pbnQoYWRkcmVzcyx1aW50MjU2KRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhIIBBIHYWNjb3VudBoFYXJnXzESEQgGEgZhbW91bnQaBWFyZ18yGjwKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoACgAaGQoACgAKAggBCgAKABILCgkKBXRlYW0xEAEq9wEKI0VUSC9FUkMyMF90cmFuc2ZlcihhZGRyZXNzLHVpbnQyNTYpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQSFAgEEglyZWNpcGllbnQaBWFyZ18xEhEIBhIGYW1vdW50GgVhcmdfMho8CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKAAoAGhkKAAoACgIIAQoACgASCwoJCgV0ZWFtMRABKpoCCi9FVEgvRVJDMjBfdHJhbnNmZXJGcm9tKGFkZHJlc3MsYWRkcmVzcyx1aW50MjU2KRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhEIBBIGc2VuZGVyGgVhcmdfMRIUCAQSCXJlY2lwaWVudBoFYXJnXzISEQgGEgZhbW91bnQaBWFyZ18zGj4KAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoACgAKABobCgAKAAoCCAEKAAoACgASCwoJCgV0ZWFtMRABKsACCihFVEgvRVJDMjBfdHJhbnNmZXJfZmlhdChhZGRyZXNzLHVpbnQyNTYpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQSFggBEgtkZXN0aW5hdGlvbhoFYXJnXzESEQgCEgZhbW91bnQaBWFyZ18yGn4KQggCEj4KKjB4MTUyZGIzMTQzYkM0MDNCNDNBQjIzYjM2MDBiN2Y5MDNGNzkzNjkxMhIQbS80NCcvNjAnLzAnLzAvMAoACgIIAQoACg0IAhIJCgcxMC4wMDAwEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEaGQoACgAKAggBCgAKABILCgkKBXRlYW0xEAEqsAEKEkVUSF9DcmVhdGVDb250cmFjdBIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50GjcKAAoACg4IAhIKCggxMDAuMDAwMBIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABGggKAAoACgIIARoTCgAKAAoAEgsKCQoFdGVhbTEQASpeCgNMVEMSEBIGc291cmNlGgZzb3VyY2USHAgBEgtkZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SEggCEgZhbW91bnQaBmFtb3VudBoTCgAKAAoAEgsKCQoFdGVhbTEQASqmAQoDWExNEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQaRgoACj4IAxI6CjhHQUxBWFlWT0lEQU9QWlRETEhJTEFKUUtDVlZGTUQ0SUtMWExTWlY1WUhPN1ZZNzRJV1pJTFVUTwoCCAEaEwoACgAKABILCgkKBXRlYW0xEAEqiQEKA1hSUBIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50GikKAAohCAMSHQobcnJycnJycnJycnJycnJycnJOQU1FdHh2TnZRCgIIARoTCgAKAAoAEgsKCQoFdGVhbTEQASqSAQoDWFRaEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQaMgoACioIAxImCiR0ejFLZTJoN3NEZGFrSEpRaDhXWDRaMzcyZHUxS0Noc2tzeVUKAggBGhMKAAoACgASCwoJCgV0ZWFtMRABKvgBChZYVFovRkExMl90cmFuc2Zlcl9maWF0EhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIARIIY29udHJhY3QaCGNvbnRyYWN0EhIIAhIGYW1vdW50GgZhbW91bnQaawpACAISPAokdHoxYnF5TWVvaWQzTktuSzFiUHRuRDFjZWIyZVNTcUFkN1FpEhRtLzQ0Jy8xNzI5Jy8wJy8wJy8wJwoACgAKABIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABGhUKAAoACgAKABILCgkKBXRlYW0xEAEqkwIKFVhUWi9GQTJfdHJhbnNmZXJfZmlhdBIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAESCGNvbnRyYWN0Gghjb250cmFjdBIWCAQSCHRva2VuX2lkGgh0b2tlbl9pZBISCAISBmFtb3VudBoGYW1vdW50Gm0KQAgCEjwKJHR6MWJxeU1lb2lkM05LbksxYlB0bkQxY2ViMmVTU3FBZDdRaRIUbS80NCcvMTcyOScvMCcvMCcvMCcKAAoACgAKABIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABGhcKAAoACgAKAAoAEgsKCQoFdGVhbTEQASphCgxYVFpfRGVsZWdhdGUSEBIGc291cmNlGgZzb3VyY2USFggBEghkZWxlZ2F0ZRoIZGVsZWdhdGUaJwoACgASIQoJCgV0ZWFtMRABCgkKBXRlYW0yEAEKCQoFdGVhbTMQASpjCg5YVFpfVW5kZWxlZ2F0ZRIQEgZzb3VyY2UaBnNvdXJjZRIWCAESCGRlbGVnYXRlGghkZWxlZ2F0ZRonCgAKABIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABMg0SCwoJCgV0ZWFtMRABOg8SCwoJCgV0ZWFtMRABGAs6DxILCgkKBXRlYW0xEAEYBQ=="
	const rulesSignature = "ClgKFHN1cGVyYWRtaW4xQGJhbmsuY29tEkCmLH/YfsuySq5RtE6qmeCvE9JMX4HmQ5kUO2nyKKy5W0a+d+G9gLg5G4HlJhyBqLJ+SBaqGt6rAqpRdyLFuR3bClgKFHN1cGVyYWRtaW4yQGJhbmsuY29tEkBGtV2np9r9usBC8IoR9zULLNfddCnZILPmFhTiFAwlzbQKoLTi1Q0pM5Wuq0uwyDSxXe4yNbqbBf/jkDpR9ZLFClgKFHN1cGVyYWRtaW4zQGJhbmsuY29tEkBVrGUvmlWaT6pHpbkgZ5orNpIEqEC8ss0mqPHDmTHeUbGZRpUB2aA+Zpt1oQ4656fu9bBqqcQl1h8tqaVU2EFi"

	wla := &model.WLAddress{
		RulesContainer:  rulesContainer,
		RulesSignatures: rulesSignature,
		Network:         "mainnet",
	}

	ruler.On("VerifySuperAdminsSignatures", ctx, tenantID, mock.Anything, mock.Anything).Return(errors.New("failed")).Once()

	err := VerifyWLAddressesIntegrity(ctx, tenantID, ruler, wla, true, config.Blockchain{})
	require.Error(t, err)
	require.False(t, errors.Is(err, bizerr.InvalidWhitelistSignature)) // Transient ruler errors should not be InvalidSig

	ruler.On("VerifySuperAdminsSignatures", ctx, tenantID, mock.Anything, mock.Anything).Return(nil).Once()
	ruler.On("CheckWhitelistedAddress", ctx, tenantID, mock.Anything, mock.Anything, mock.Anything).Return(errors.New("failed")).Once()

	err = VerifyWLAddressesIntegrity(ctx, tenantID, ruler, wla, true, config.Blockchain{})
	require.Error(t, err)
	require.False(t, errors.Is(err, bizerr.InvalidWhitelistSignature)) // Transient ruler errors should not be InvalidSig
}

func TestHelper_VerifyWLAddressesIntegrity_KnownErrors(t *testing.T) {
	ctx := context.Background()
	ruler := &rule_mocks.Ruler{}

	tenantID := uint64(1)
	const rulesContainer = "CtABChdoc21zbG90MEB0YXVydXNncm91cC5jaBKxAS0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRXFZWUIyN2xVVmZSeG5KWUMvWng3VTJIamR3OUkKZHg2VW53dytQNG4xNUE1U1R6RVpEQmFYSSs3MTNzRXArUTEzQkQyalluSkJzSmdpbjJINDk2SUk3QT09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLRoBBQrOAQoUc3VwZXJhZG1pbjFAYmFuay5jb20SsgEtLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLQpNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUVNMk50emFGaG03eElSM092V3E1Y2hXMy9HRXZXCkwrM3Vxb0U2bEVKMTNlV2J1bHhzUC81aDM2VkNxWURJR04vMHdEZVd3TFlkcHU1SGhTWFdoeENzQ0E9PQotLS0tLUVORCBQVUJMSUMgS0VZLS0tLS0KGgEDCs4BChRzdXBlcmFkbWluMkBiYW5rLmNvbRKyAS0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRVk5ekd1Z3pOTElmcFp1YVVyenl3RWgvOFpkdFgKNElJdUlwREhMdkozNmdsRmpmeHhTWmRPRzZ5SEtGRmxRaDFHWDNPQ0ZaeEhlK3hlT0dCSkhCZ3JhQT09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQoaAQMKzgEKFHN1cGVyYWRtaW4zQGJhbmsuY29tErIBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFVjJ6RUR2WmpKL3FSK1FoMXIwc0tOY2kzOXc3OQpCMDBOZzVNR2c0d1JNN0FoOXByMUdia2dyS0lVZjRrYUhQanJQVmFRS0lSOHpEVTNqZ20wbFd4ZUhBPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tChoBAwrIAQoOdGVhbTFAYmFuay5jb20SsQEtLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLQpNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUV2N2FWLzcvaTNqOUVocTBOOHJrTkF3c0hCdVNwCnVRYWJpa2JaclQrZUFDSUFPeUo2bnVzVm9RbzA5YU9zV3FRbUkzNUJRU3ZaUXNld092a05sWEZtMGc9PQotLS0tLUVORCBQVUJMSUMgS0VZLS0tLS0aAgQACscBCg50ZWFtMkBiYW5rLmNvbRKxAS0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRTRVQW8rR054dzR0RXFkbVREaTZ2Mk1acTJ1ZzgKYWpXOC9NbnFKL1FkNGJuaVB5RHZJVHJTRVpVeVA5VHZZcGtMQWJnL0FDeGNSL3lBNmxCRWd0RTYwUT09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLRoBAArHAQoOdGVhbTNAYmFuay5jb20SsQEtLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLQpNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUVIaml3VThDd3hQUEYrU3hiVFZPbTdaMW5kOVA2Cm1UYkZDMkZZVVlpU2xBSndmRTd3b003QkFPZzZiOFcweTBKSUpBYyt0MTZWN3pPTVd6c0ZWbWVlNmc9PQotLS0tLUVORCBQVUJMSUMgS0VZLS0tLS0aAQAK1gEKHXZhbGlkYXRvci1jb3JlQHRhdXJ1c2dyb3VwLmNoErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFWVBYSUI0bXRxeTBBTHVFS2RZQWZRcFdtc0t1NgpEbTVhMDVkY1JVRlc1MkpHazBNNzdlc2FvSHNpSHVHODlxRnF5ZkZJLzJQZjRTL2hMbkhCR1dNbVJnPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgEBEjUKFF9fdGF1cnVzX3RlY2huaWNhbF9fEh12YWxpZGF0b3ItY29yZUB0YXVydXNncm91cC5jaBIfCg1maXJzdF9saW5lX0FEEg50ZWFtMUBiYW5rLmNvbRIgCg5zZWNvbmRfbGluZV9BRBIOdGVhbTJAYmFuay5jb20SFwoFdGVhbTESDnRlYW0xQGJhbmsuY29tEhcKBXRlYW0yEg50ZWFtMkBiYW5rLmNvbRIXCgV0ZWFtMxIOdGVhbTNAYmFuay5jb20SHwoNdGhpcmRfbGluZV9BRBIOdGVhbTNAYmFuay5jb20qXgoDQkNIEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQaEwoACgAKABILCgkKBXRlYW0xEAEqXgoDQlRDEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQaEwoACgAKABILCgkKBXRlYW0xEAEqYQoIRGllbS9YVVMSCBIGc291cmNlEg8IARILZGVzdGluYXRpb24SCggCEgZhbW91bnQaLgoACiYIAxIiCiAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMAoCCAEqJQoNRGllbS9YVVNfQnVybhIIEgZzb3VyY2USCggCEgZhbW91bnQqJQoNRGllbS9YVVNfTWludBIIEgZzb3VyY2USCggCEgZhbW91bnQqtgEKA0VUQxIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50EhQIAxIHcGF5bG9hZBoHcGF5bG9hZBo8CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKAggBGhcKAAoACgAKAggBEgsKCQoFdGVhbTEQASq2AQoDRVRIEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQSFAgDEgdwYXlsb2FkGgdwYXlsb2FkGjwKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoCCAEaFwoACgAKAAoCCAESCwoJCgV0ZWFtMRABKocCCjBFVEgvQ01UQTIwLUtZQ192YWxpZGF0ZUtZQ1VudGlsKGFkZHJlc3MsdWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBITCAQSCF9hZGRyZXNzGgVhcmdfMRIVCAYSCl90aW1lc3RhbXAaBWFyZ18yGjwKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoACgAaGQoACgAKAggBCgAKABILCgkKBXRlYW0xEAEqjwIKNkVUSC9DTVRBMjAtS1lDX3ZhbGlkYXRlTWFueUtZQ1VudGlsKGFkZHJlc3NbXSx1aW50MjU2KRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhUIBxIKX2FkZHJlc3NlcxoFYXJnXzESFQgGEgpfdGltZXN0YW1wGgVhcmdfMho8CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKAAoAGhkKAAoACgIIAQoACgASCwoJCgV0ZWFtMRABKuIBCilFVEgvQ01UQTIwLVJVTEVFTkdJTkVfc2V0UnVsZXMoYWRkcmVzc1tdKRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhAIBxIFcnVsZXMaBWFyZ18xGjoKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoAGhcKAAoACgIIAQoAEgsKCQoFdGVhbTEQASr2AQojRVRIL0NNVEEyMF9hcHByb3ZlKGFkZHJlc3MsdWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBITCAQSCF9zcGVuZGVyGgVhcmdfMRIRCAYSBl92YWx1ZRoFYXJnXzIaPAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAKABoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASqKAgotRVRIL0NNVEEyMF9kZWNyZWFzZUFsbG93YW5jZShhZGRyZXNzLHVpbnQyNTYpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQSEwgEEghfc3BlbmRlchoFYXJnXzESGwgGEhBfc3VidHJhY3RlZFZhbHVlGgVhcmdfMho8CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKAAoAGhkKAAoACgIIAQoACgASCwoJCgV0ZWFtMRABKt0BCh1FVEgvQ01UQTIwX2Rlc3Ryb3koYWRkcmVzc1tdKRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhcIBxIMc2hhcmVob2xkZXJzGgVhcmdfMRo6CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKABoXCgAKAAoCCAEKABILCgkKBXRlYW0xEAEqhQIKLUVUSC9DTVRBMjBfaW5jcmVhc2VBbGxvd2FuY2UoYWRkcmVzcyx1aW50MjU2KRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhMIBBIIX3NwZW5kZXIaBWFyZ18xEhYIBhILX2FkZGVkVmFsdWUaBWFyZ18yGjwKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoACgAaGQoACgAKAggBCgAKABILCgkKBXRlYW0xEAEq0wEKGUVUSC9DTVRBMjBfaXNzdWUodWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBIRCAYSBl92YWx1ZRoFYXJnXzEaOgoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAaFwoACgAKAggBCgASCwoJCgV0ZWFtMRABKrUBChJFVEgvQ01UQTIwX3BhdXNlKCkSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBo4CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEaFQoACgAKAggBEgsKCQoFdGVhbTEQASr8AQokRVRIL0NNVEEyMF9yZWFzc2lnbihhZGRyZXNzLGFkZHJlc3MpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQSEwgEEghvcmlnaW5hbBoFYXJnXzESFggEEgtyZXBsYWNlbWVudBoFYXJnXzIaPAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAKABoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASrUAQoaRVRIL0NNVEEyMF9yZWRlZW0odWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBIRCAYSBl92YWx1ZRoFYXJnXzEaOgoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAaFwoACgAKAggBCgASCwoJCgV0ZWFtMRABKsEBCh5FVEgvQ01UQTIwX3Jlbm91bmNlT3duZXJzaGlwKCkSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBo4CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEaFQoACgAKAggBEgsKCQoFdGVhbTEQASrZAQodRVRIL0NNVEEyMF9zZXRDb250YWN0KHN0cmluZykSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBITCAQSCF9jb250YWN0GgVhcmdfMRo6CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKABoXCgAKAAoCCAEKABILCgkKBXRlYW0xEAEq3AEKH0VUSC9DTVRBMjBfc2V0TXlJZGVudGl0eShieXRlcykSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBIUCAMSCV9pZGVudGl0eRoFYXJnXzEaOgoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAaFwoACgAKAggBCgASCwoJCgV0ZWFtMRABKuABCiFFVEgvQ01UQTIwX3NldFJ1bGVFbmdpbmUoYWRkcmVzcykSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBIWCAQSC19ydWxlRW5naW5lGgVhcmdfMRo6CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKABoXCgAKAAoCCAEKABILCgkKBXRlYW0xEAEq8gEKJEVUSC9DTVRBMjBfdHJhbnNmZXIoYWRkcmVzcyx1aW50MjU2KRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50Eg4IBBIDX3RvGgVhcmdfMRIRCAYSBl92YWx1ZRoFYXJnXzIaPAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAKABoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASqUAgowRVRIL0NNVEEyMF90cmFuc2ZlckZyb20oYWRkcmVzcyxhZGRyZXNzLHVpbnQyNTYpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQSEAgEEgVfZnJvbRoFYXJnXzESDggEEgNfdG8aBWFyZ18yEhEIBhIGX3ZhbHVlGgVhcmdfMxo+CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKAAoACgAaGwoACgAKAggBCgAKAAoAEgsKCQoFdGVhbTEQASriAQolRVRIL0NNVEEyMF90cmFuc2Zlck93bmVyc2hpcChhZGRyZXNzKRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhQIBBIJX25ld093bmVyGgVhcmdfMRo6CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKABoXCgAKAAoCCAEKABILCgkKBXRlYW0xEAEqtwEKFEVUSC9DTVRBMjBfdW5wYXVzZSgpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQaOAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBGhUKAAoACgIIARILCgkKBXRlYW0xEAEq9AEKIkVUSC9FUkMyMF9hcHByb3ZlKGFkZHJlc3MsdWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBISCAQSB3NwZW5kZXIaBWFyZ18xEhEIBhIGYW1vdW50GgVhcmdfMho8CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKAAoAGhkKAAoACgIIAQoACgASCwoJCgV0ZWFtMRABKvEBCh9FVEgvRVJDMjBfYnVybihhZGRyZXNzLHVpbnQyNTYpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQSEggEEgdhY2NvdW50GgVhcmdfMRIRCAYSBmFtb3VudBoFYXJnXzIaPAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAKABoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASqIAgosRVRIL0VSQzIwX2RlY3JlYXNlQWxsb3dhbmNlKGFkZHJlc3MsdWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBITCAQSCF9zcGVuZGVyGgVhcmdfMRIaCAYSD3N1YnRyYWN0ZWRWYWx1ZRoFYXJnXzIaPAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAKABoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASqCAgosRVRIL0VSQzIwX2luY3JlYXNlQWxsb3dhbmNlKGFkZHJlc3MsdWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBISCAQSB3NwZW5kZXIaBWFyZ18xEhUIBhIKYWRkZWRWYWx1ZRoFYXJnXzIaPAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAKABoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASrxAQofRVRIL0VSQzIwX21pbnQoYWRkcmVzcyx1aW50MjU2KRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhIIBBIHYWNjb3VudBoFYXJnXzESEQgGEgZhbW91bnQaBWFyZ18yGjwKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoACgAaGQoACgAKAggBCgAKABILCgkKBXRlYW0xEAEq9wEKI0VUSC9FUkMyMF90cmFuc2ZlcihhZGRyZXNzLHVpbnQyNTYpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQSFAgEEglyZWNpcGllbnQaBWFyZ18xEhEIBhIGYW1vdW50GgVhcmdfMho8CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKAAoAGhkKAAoACgIIAQoACgASCwoJCgV0ZWFtMRABKpoCCi9FVEgvRVJDMjBfdHJhbnNmZXJGcm9tKGFkZHJlc3MsYWRkcmVzcyx1aW50MjU2KRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhEIBBIGc2VuZGVyGgVhcmdfMRIUCAQSCXJlY2lwaWVudBoFYXJnXzISEQgGEgZhbW91bnQaBWFyZ18zGj4KAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoACgAKABobCgAKAAoCCAEKAAoACgASCwoJCgV0ZWFtMRABKsACCihFVEgvRVJDMjBfdHJhbnNmZXJfZmlhdChhZGRyZXNzLHVpbnQyNTYpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQSFggBEgtkZXN0aW5hdGlvbhoFYXJnXzESEQgCEgZhbW91bnQaBWFyZ18yGn4KQggCEj4KKjB4MTUyZGIzMTQzYkM0MDNCNDNBQjIzYjM2MDBiN2Y5MDNGNzkzNjkxMhIQbS80NCcvNjAnLzAnLzAvMAoACgIIAQoACg0IAhIJCgcxMC4wMDAwEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEaGQoACgAKAggBCgAKABILCgkKBXRlYW0xEAEqsAEKEkVUSF9DcmVhdGVDb250cmFjdBIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50GjcKAAoACg4IAhIKCggxMDAuMDAwMBIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABGggKAAoACgIIARoTCgAKAAoAEgsKCQoFdGVhbTEQASpeCgNMVEMSEBIGc291cmNlGgZzb3VyY2USHAgBEgtkZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SEggCEgZhbW91bnQaBmFtb3VudBoTCgAKAAoAEgsKCQoFdGVhbTEQASqmAQoDWExNEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQaRgoACj4IAxI6CjhHQUxBWFlWT0lEQU9QWlRETEhJTEFKUUtDVlZGTUQ0SUtMWExTWlY1WUhPN1ZZNzRJV1pJTFVUTwoCCAEaEwoACgAKABILCgkKBXRlYW0xEAEqiQEKA1hSUBIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50GikKAAohCAMSHQobcnJycnJycnJycnJycnJycnJOQU1FdHh2TnZRCgIIARoTCgAKAAoAEgsKCQoFdGVhbTEQASqSAQoDWFRaEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQaMgoACioIAxImCiR0ejFLZTJoN3NEZGFrSEpRaDhXWDRaMzcyZHUxS0Noc2tzeVUKAggBGhMKAAoACgASCwoJCgV0ZWFtMRABKvgBChZYVFovRkExMl90cmFuc2Zlcl9maWF0EhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIARIIY29udHJhY3QaCGNvbnRyYWN0EhIIAhIGYW1vdW50GgZhbW91bnQaawpACAISPAokdHoxYnF5TWVvaWQzTktuSzFiUHRuRDFjZWIyZVNTcUFkN1FpEhRtLzQ0Jy8xNzI5Jy8wJy8wJy8wJwoACgAKABIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABGhUKAAoACgAKABILCgkKBXRlYW0xEAEqkwIKFVhUWi9GQTJfdHJhbnNmZXJfZmlhdBIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAESCGNvbnRyYWN0Gghjb250cmFjdBIWCAQSCHRva2VuX2lkGgh0b2tlbl9pZBISCAISBmFtb3VudBoGYW1vdW50Gm0KQAgCEjwKJHR6MWJxeU1lb2lkM05LbksxYlB0bkQxY2ViMmVTU3FBZDdRaRIUbS80NCcvMTcyOScvMCcvMCcvMCcKAAoACgAKABIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABGhcKAAoACgAKAAoAEgsKCQoFdGVhbTEQASphCgxYVFpfRGVsZWdhdGUSEBIGc291cmNlGgZzb3VyY2USFggBEghkZWxlZ2F0ZRoIZGVsZWdhdGUaJwoACgASIQoJCgV0ZWFtMRABCgkKBXRlYW0yEAEKCQoFdGVhbTMQASpjCg5YVFpfVW5kZWxlZ2F0ZRIQEgZzb3VyY2UaBnNvdXJjZRIWCAESCGRlbGVnYXRlGghkZWxlZ2F0ZRonCgAKABIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABMg0SCwoJCgV0ZWFtMRABOg8SCwoJCgV0ZWFtMRABGAs6DxILCgkKBXRlYW0xEAEYBQ=="
	const rulesSignature = "ClgKFHN1cGVyYWRtaW4xQGJhbmsuY29tEkCmLH/YfsuySq5RtE6qmeCvE9JMX4HmQ5kUO2nyKKy5W0a+d+G9gLg5G4HlJhyBqLJ+SBaqGt6rAqpRdyLFuR3bClgKFHN1cGVyYWRtaW4yQGJhbmsuY29tEkBGtV2np9r9usBC8IoR9zULLNfddCnZILPmFhTiFAwlzbQKoLTi1Q0pM5Wuq0uwyDSxXe4yNbqbBf/jkDpR9ZLFClgKFHN1cGVyYWRtaW4zQGJhbmsuY29tEkBVrGUvmlWaT6pHpbkgZ5orNpIEqEC8ss0mqPHDmTHeUbGZRpUB2aA+Zpt1oQ4656fu9bBqqcQl1h8tqaVU2EFi"

	wla := &model.WLAddress{
		RulesContainer:  rulesContainer,
		RulesSignatures: rulesSignature,
	}

	ruler.On("VerifySuperAdminsSignatures", ctx, tenantID, mock.Anything, mock.Anything).Return(bizerr.NoMinRequiredSigThreshold).Once()

	err := VerifyWLAddressesIntegrity(ctx, tenantID, ruler, wla, true, config.Blockchain{})
	require.Error(t, err)
	require.True(t, errors.Is(err, bizerr.InvalidSuperadminRulesSignature)) // Some known ruler errors should be invalid sig

	ruler.On("VerifySuperAdminsSignatures", ctx, tenantID, mock.Anything, mock.Anything).Return(bizerr.NotEnoughRulesSignatures).Once()

	err = VerifyWLAddressesIntegrity(ctx, tenantID, ruler, wla, true, config.Blockchain{})
	require.Error(t, err)
	require.True(t, errors.Is(err, bizerr.InvalidSuperadminRulesSignature)) // Some known ruler errors should be invalid sig

	ruler.On("VerifySuperAdminsSignatures", ctx, tenantID, mock.Anything, mock.Anything).Return(nil).Once()
	ruler.On("CheckWhitelistedAddress", ctx, tenantID, mock.Anything, mock.Anything, mock.Anything).Return(bizerr.EntityNotFullySigned).Once()

	err = VerifyWLAddressesIntegrity(ctx, tenantID, ruler, wla, true, config.Blockchain{})
	require.Error(t, err)
	require.True(t, errors.Is(err, bizerr.InvalidWhitelistSignature)) // Some known ruler errors should be invalid sig
}

func TestHelper_VerifyWLAddressesIntegrity_InvalidDBFieldSigFields(t *testing.T) {
	ctx := context.Background()
	ruler := &rule_mocks.Ruler{}

	tenantID := uint64(1)
	const env = "Cq8BCmsKDnRlYW0xQGJhbmsuY29tEkCZGcVroqu90gO1wQz4qcUB42So8jjWLJBtu7Wg/x0KfrfC+w2asrIFYWfmrxVHouulWYfeP43NdaRVH5i784UoGhdzaWduZWQgYnkgdHJhZGVkIGRhZW1vbhJAMDE5MDMyMTQ3N2Y2NTY0MTFkNGIxMmZiNzEzNTczNWFmNDZiZjMyNjI3YzVhMGNiZmU2OWFlNzRiYjhlZmYzMRJwCgNFVEgaKjB4ZmZhODhlNzk4ZTY5MDljMDZiNjU1ZDYzZTdlODU5NWJiYTc0NDYxZCoXZ2FuYWNoZSBidXQgZnJvbSB0cmFkZWQyJGQ3YWQwMjIyLTY1NDctNDNkNi04YWMxLTc5ZjZkNGM3Y2RiZg=="
	const rulesContainer = "CtABChdoc21zbG90MEB0YXVydXNncm91cC5jaBKxAS0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRXFZWUIyN2xVVmZSeG5KWUMvWng3VTJIamR3OUkKZHg2VW53dytQNG4xNUE1U1R6RVpEQmFYSSs3MTNzRXArUTEzQkQyalluSkJzSmdpbjJINDk2SUk3QT09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLRoBBQrOAQoUc3VwZXJhZG1pbjFAYmFuay5jb20SsgEtLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLQpNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUVNMk50emFGaG03eElSM092V3E1Y2hXMy9HRXZXCkwrM3Vxb0U2bEVKMTNlV2J1bHhzUC81aDM2VkNxWURJR04vMHdEZVd3TFlkcHU1SGhTWFdoeENzQ0E9PQotLS0tLUVORCBQVUJMSUMgS0VZLS0tLS0KGgEDCs4BChRzdXBlcmFkbWluMkBiYW5rLmNvbRKyAS0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRVk5ekd1Z3pOTElmcFp1YVVyenl3RWgvOFpkdFgKNElJdUlwREhMdkozNmdsRmpmeHhTWmRPRzZ5SEtGRmxRaDFHWDNPQ0ZaeEhlK3hlT0dCSkhCZ3JhQT09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQoaAQMKzgEKFHN1cGVyYWRtaW4zQGJhbmsuY29tErIBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFVjJ6RUR2WmpKL3FSK1FoMXIwc0tOY2kzOXc3OQpCMDBOZzVNR2c0d1JNN0FoOXByMUdia2dyS0lVZjRrYUhQanJQVmFRS0lSOHpEVTNqZ20wbFd4ZUhBPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tChoBAwrIAQoOdGVhbTFAYmFuay5jb20SsQEtLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLQpNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUV2N2FWLzcvaTNqOUVocTBOOHJrTkF3c0hCdVNwCnVRYWJpa2JaclQrZUFDSUFPeUo2bnVzVm9RbzA5YU9zV3FRbUkzNUJRU3ZaUXNld092a05sWEZtMGc9PQotLS0tLUVORCBQVUJMSUMgS0VZLS0tLS0aAgQACscBCg50ZWFtMkBiYW5rLmNvbRKxAS0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRTRVQW8rR054dzR0RXFkbVREaTZ2Mk1acTJ1ZzgKYWpXOC9NbnFKL1FkNGJuaVB5RHZJVHJTRVpVeVA5VHZZcGtMQWJnL0FDeGNSL3lBNmxCRWd0RTYwUT09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLRoBAArHAQoOdGVhbTNAYmFuay5jb20SsQEtLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLQpNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUVIaml3VThDd3hQUEYrU3hiVFZPbTdaMW5kOVA2Cm1UYkZDMkZZVVlpU2xBSndmRTd3b003QkFPZzZiOFcweTBKSUpBYyt0MTZWN3pPTVd6c0ZWbWVlNmc9PQotLS0tLUVORCBQVUJMSUMgS0VZLS0tLS0aAQAK1gEKHXZhbGlkYXRvci1jb3JlQHRhdXJ1c2dyb3VwLmNoErEBLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFWVBYSUI0bXRxeTBBTHVFS2RZQWZRcFdtc0t1NgpEbTVhMDVkY1JVRlc1MkpHazBNNzdlc2FvSHNpSHVHODlxRnF5ZkZJLzJQZjRTL2hMbkhCR1dNbVJnPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tGgEBEjUKFF9fdGF1cnVzX3RlY2huaWNhbF9fEh12YWxpZGF0b3ItY29yZUB0YXVydXNncm91cC5jaBIfCg1maXJzdF9saW5lX0FEEg50ZWFtMUBiYW5rLmNvbRIgCg5zZWNvbmRfbGluZV9BRBIOdGVhbTJAYmFuay5jb20SFwoFdGVhbTESDnRlYW0xQGJhbmsuY29tEhcKBXRlYW0yEg50ZWFtMkBiYW5rLmNvbRIXCgV0ZWFtMxIOdGVhbTNAYmFuay5jb20SHwoNdGhpcmRfbGluZV9BRBIOdGVhbTNAYmFuay5jb20qXgoDQkNIEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQaEwoACgAKABILCgkKBXRlYW0xEAEqXgoDQlRDEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQaEwoACgAKABILCgkKBXRlYW0xEAEqYQoIRGllbS9YVVMSCBIGc291cmNlEg8IARILZGVzdGluYXRpb24SCggCEgZhbW91bnQaLgoACiYIAxIiCiAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMAoCCAEqJQoNRGllbS9YVVNfQnVybhIIEgZzb3VyY2USCggCEgZhbW91bnQqJQoNRGllbS9YVVNfTWludBIIEgZzb3VyY2USCggCEgZhbW91bnQqtgEKA0VUQxIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50EhQIAxIHcGF5bG9hZBoHcGF5bG9hZBo8CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKAggBGhcKAAoACgAKAggBEgsKCQoFdGVhbTEQASq2AQoDRVRIEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQSFAgDEgdwYXlsb2FkGgdwYXlsb2FkGjwKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoCCAEaFwoACgAKAAoCCAESCwoJCgV0ZWFtMRABKocCCjBFVEgvQ01UQTIwLUtZQ192YWxpZGF0ZUtZQ1VudGlsKGFkZHJlc3MsdWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBITCAQSCF9hZGRyZXNzGgVhcmdfMRIVCAYSCl90aW1lc3RhbXAaBWFyZ18yGjwKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoACgAaGQoACgAKAggBCgAKABILCgkKBXRlYW0xEAEqjwIKNkVUSC9DTVRBMjAtS1lDX3ZhbGlkYXRlTWFueUtZQ1VudGlsKGFkZHJlc3NbXSx1aW50MjU2KRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhUIBxIKX2FkZHJlc3NlcxoFYXJnXzESFQgGEgpfdGltZXN0YW1wGgVhcmdfMho8CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKAAoAGhkKAAoACgIIAQoACgASCwoJCgV0ZWFtMRABKuIBCilFVEgvQ01UQTIwLVJVTEVFTkdJTkVfc2V0UnVsZXMoYWRkcmVzc1tdKRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhAIBxIFcnVsZXMaBWFyZ18xGjoKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoAGhcKAAoACgIIAQoAEgsKCQoFdGVhbTEQASr2AQojRVRIL0NNVEEyMF9hcHByb3ZlKGFkZHJlc3MsdWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBITCAQSCF9zcGVuZGVyGgVhcmdfMRIRCAYSBl92YWx1ZRoFYXJnXzIaPAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAKABoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASqKAgotRVRIL0NNVEEyMF9kZWNyZWFzZUFsbG93YW5jZShhZGRyZXNzLHVpbnQyNTYpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQSEwgEEghfc3BlbmRlchoFYXJnXzESGwgGEhBfc3VidHJhY3RlZFZhbHVlGgVhcmdfMho8CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKAAoAGhkKAAoACgIIAQoACgASCwoJCgV0ZWFtMRABKt0BCh1FVEgvQ01UQTIwX2Rlc3Ryb3koYWRkcmVzc1tdKRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhcIBxIMc2hhcmVob2xkZXJzGgVhcmdfMRo6CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKABoXCgAKAAoCCAEKABILCgkKBXRlYW0xEAEqhQIKLUVUSC9DTVRBMjBfaW5jcmVhc2VBbGxvd2FuY2UoYWRkcmVzcyx1aW50MjU2KRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhMIBBIIX3NwZW5kZXIaBWFyZ18xEhYIBhILX2FkZGVkVmFsdWUaBWFyZ18yGjwKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoACgAaGQoACgAKAggBCgAKABILCgkKBXRlYW0xEAEq0wEKGUVUSC9DTVRBMjBfaXNzdWUodWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBIRCAYSBl92YWx1ZRoFYXJnXzEaOgoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAaFwoACgAKAggBCgASCwoJCgV0ZWFtMRABKrUBChJFVEgvQ01UQTIwX3BhdXNlKCkSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBo4CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEaFQoACgAKAggBEgsKCQoFdGVhbTEQASr8AQokRVRIL0NNVEEyMF9yZWFzc2lnbihhZGRyZXNzLGFkZHJlc3MpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQSEwgEEghvcmlnaW5hbBoFYXJnXzESFggEEgtyZXBsYWNlbWVudBoFYXJnXzIaPAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAKABoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASrUAQoaRVRIL0NNVEEyMF9yZWRlZW0odWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBIRCAYSBl92YWx1ZRoFYXJnXzEaOgoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAaFwoACgAKAggBCgASCwoJCgV0ZWFtMRABKsEBCh5FVEgvQ01UQTIwX3Jlbm91bmNlT3duZXJzaGlwKCkSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBo4CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEaFQoACgAKAggBEgsKCQoFdGVhbTEQASrZAQodRVRIL0NNVEEyMF9zZXRDb250YWN0KHN0cmluZykSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBITCAQSCF9jb250YWN0GgVhcmdfMRo6CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKABoXCgAKAAoCCAEKABILCgkKBXRlYW0xEAEq3AEKH0VUSC9DTVRBMjBfc2V0TXlJZGVudGl0eShieXRlcykSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBIUCAMSCV9pZGVudGl0eRoFYXJnXzEaOgoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAaFwoACgAKAggBCgASCwoJCgV0ZWFtMRABKuABCiFFVEgvQ01UQTIwX3NldFJ1bGVFbmdpbmUoYWRkcmVzcykSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBIWCAQSC19ydWxlRW5naW5lGgVhcmdfMRo6CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKABoXCgAKAAoCCAEKABILCgkKBXRlYW0xEAEq8gEKJEVUSC9DTVRBMjBfdHJhbnNmZXIoYWRkcmVzcyx1aW50MjU2KRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50Eg4IBBIDX3RvGgVhcmdfMRIRCAYSBl92YWx1ZRoFYXJnXzIaPAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAKABoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASqUAgowRVRIL0NNVEEyMF90cmFuc2ZlckZyb20oYWRkcmVzcyxhZGRyZXNzLHVpbnQyNTYpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQSEAgEEgVfZnJvbRoFYXJnXzESDggEEgNfdG8aBWFyZ18yEhEIBhIGX3ZhbHVlGgVhcmdfMxo+CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKAAoACgAaGwoACgAKAggBCgAKAAoAEgsKCQoFdGVhbTEQASriAQolRVRIL0NNVEEyMF90cmFuc2Zlck93bmVyc2hpcChhZGRyZXNzKRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhQIBBIJX25ld093bmVyGgVhcmdfMRo6CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKABoXCgAKAAoCCAEKABILCgkKBXRlYW0xEAEqtwEKFEVUSC9DTVRBMjBfdW5wYXVzZSgpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQaOAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBGhUKAAoACgIIARILCgkKBXRlYW0xEAEq9AEKIkVUSC9FUkMyMF9hcHByb3ZlKGFkZHJlc3MsdWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBISCAQSB3NwZW5kZXIaBWFyZ18xEhEIBhIGYW1vdW50GgVhcmdfMho8CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKAAoAGhkKAAoACgIIAQoACgASCwoJCgV0ZWFtMRABKvEBCh9FVEgvRVJDMjBfYnVybihhZGRyZXNzLHVpbnQyNTYpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQSEggEEgdhY2NvdW50GgVhcmdfMRIRCAYSBmFtb3VudBoFYXJnXzIaPAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAKABoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASqIAgosRVRIL0VSQzIwX2RlY3JlYXNlQWxsb3dhbmNlKGFkZHJlc3MsdWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBITCAQSCF9zcGVuZGVyGgVhcmdfMRIaCAYSD3N1YnRyYWN0ZWRWYWx1ZRoFYXJnXzIaPAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAKABoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASqCAgosRVRIL0VSQzIwX2luY3JlYXNlQWxsb3dhbmNlKGFkZHJlc3MsdWludDI1NikSFBIKRVRIX3NvdXJjZRoGc291cmNlEiAIARIPRVRIX2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAISCkVUSF9hbW91bnQaBmFtb3VudBISCAQSB3NwZW5kZXIaBWFyZ18xEhUIBhIKYWRkZWRWYWx1ZRoFYXJnXzIaPAoACjAIAxIsCioweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYKAggBCgAKABoZCgAKAAoCCAEKAAoAEgsKCQoFdGVhbTEQASrxAQofRVRIL0VSQzIwX21pbnQoYWRkcmVzcyx1aW50MjU2KRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhIIBBIHYWNjb3VudBoFYXJnXzESEQgGEgZhbW91bnQaBWFyZ18yGjwKAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoACgAaGQoACgAKAggBCgAKABILCgkKBXRlYW0xEAEq9wEKI0VUSC9FUkMyMF90cmFuc2ZlcihhZGRyZXNzLHVpbnQyNTYpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQSFAgEEglyZWNpcGllbnQaBWFyZ18xEhEIBhIGYW1vdW50GgVhcmdfMho8CgAKMAgDEiwKKjB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRgoCCAEKAAoAGhkKAAoACgIIAQoACgASCwoJCgV0ZWFtMRABKpoCCi9FVEgvRVJDMjBfdHJhbnNmZXJGcm9tKGFkZHJlc3MsYWRkcmVzcyx1aW50MjU2KRIUEgpFVEhfc291cmNlGgZzb3VyY2USIAgBEg9FVEhfZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIAhIKRVRIX2Ftb3VudBoGYW1vdW50EhEIBBIGc2VuZGVyGgVhcmdfMRIUCAQSCXJlY2lwaWVudBoFYXJnXzISEQgGEgZhbW91bnQaBWFyZ18zGj4KAAowCAMSLAoqMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGCgIIAQoACgAKABobCgAKAAoCCAEKAAoACgASCwoJCgV0ZWFtMRABKsACCihFVEgvRVJDMjBfdHJhbnNmZXJfZmlhdChhZGRyZXNzLHVpbnQyNTYpEhQSCkVUSF9zb3VyY2UaBnNvdXJjZRIgCAESD0VUSF9kZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SFggCEgpFVEhfYW1vdW50GgZhbW91bnQSFggBEgtkZXN0aW5hdGlvbhoFYXJnXzESEQgCEgZhbW91bnQaBWFyZ18yGn4KQggCEj4KKjB4MTUyZGIzMTQzYkM0MDNCNDNBQjIzYjM2MDBiN2Y5MDNGNzkzNjkxMhIQbS80NCcvNjAnLzAnLzAvMAoACgIIAQoACg0IAhIJCgcxMC4wMDAwEiEKCQoFdGVhbTEQAQoJCgV0ZWFtMhABCgkKBXRlYW0zEAEaGQoACgAKAggBCgAKABILCgkKBXRlYW0xEAEqsAEKEkVUSF9DcmVhdGVDb250cmFjdBIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50GjcKAAoACg4IAhIKCggxMDAuMDAwMBIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABGggKAAoACgIIARoTCgAKAAoAEgsKCQoFdGVhbTEQASpeCgNMVEMSEBIGc291cmNlGgZzb3VyY2USHAgBEgtkZXN0aW5hdGlvbhoLZGVzdGluYXRpb24SEggCEgZhbW91bnQaBmFtb3VudBoTCgAKAAoAEgsKCQoFdGVhbTEQASqmAQoDWExNEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQaRgoACj4IAxI6CjhHQUxBWFlWT0lEQU9QWlRETEhJTEFKUUtDVlZGTUQ0SUtMWExTWlY1WUhPN1ZZNzRJV1pJTFVUTwoCCAEaEwoACgAKABILCgkKBXRlYW0xEAEqiQEKA1hSUBIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhISCAISBmFtb3VudBoGYW1vdW50GikKAAohCAMSHQobcnJycnJycnJycnJycnJycnJOQU1FdHh2TnZRCgIIARoTCgAKAAoAEgsKCQoFdGVhbTEQASqSAQoDWFRaEhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhIIAhIGYW1vdW50GgZhbW91bnQaMgoACioIAxImCiR0ejFLZTJoN3NEZGFrSEpRaDhXWDRaMzcyZHUxS0Noc2tzeVUKAggBGhMKAAoACgASCwoJCgV0ZWFtMRABKvgBChZYVFovRkExMl90cmFuc2Zlcl9maWF0EhASBnNvdXJjZRoGc291cmNlEhwIARILZGVzdGluYXRpb24aC2Rlc3RpbmF0aW9uEhYIARIIY29udHJhY3QaCGNvbnRyYWN0EhIIAhIGYW1vdW50GgZhbW91bnQaawpACAISPAokdHoxYnF5TWVvaWQzTktuSzFiUHRuRDFjZWIyZVNTcUFkN1FpEhRtLzQ0Jy8xNzI5Jy8wJy8wJy8wJwoACgAKABIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABGhUKAAoACgAKABILCgkKBXRlYW0xEAEqkwIKFVhUWi9GQTJfdHJhbnNmZXJfZmlhdBIQEgZzb3VyY2UaBnNvdXJjZRIcCAESC2Rlc3RpbmF0aW9uGgtkZXN0aW5hdGlvbhIWCAESCGNvbnRyYWN0Gghjb250cmFjdBIWCAQSCHRva2VuX2lkGgh0b2tlbl9pZBISCAISBmFtb3VudBoGYW1vdW50Gm0KQAgCEjwKJHR6MWJxeU1lb2lkM05LbksxYlB0bkQxY2ViMmVTU3FBZDdRaRIUbS80NCcvMTcyOScvMCcvMCcvMCcKAAoACgAKABIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABGhcKAAoACgAKAAoAEgsKCQoFdGVhbTEQASphCgxYVFpfRGVsZWdhdGUSEBIGc291cmNlGgZzb3VyY2USFggBEghkZWxlZ2F0ZRoIZGVsZWdhdGUaJwoACgASIQoJCgV0ZWFtMRABCgkKBXRlYW0yEAEKCQoFdGVhbTMQASpjCg5YVFpfVW5kZWxlZ2F0ZRIQEgZzb3VyY2UaBnNvdXJjZRIWCAESCGRlbGVnYXRlGghkZWxlZ2F0ZRonCgAKABIhCgkKBXRlYW0xEAEKCQoFdGVhbTIQAQoJCgV0ZWFtMxABMg0SCwoJCgV0ZWFtMRABOg8SCwoJCgV0ZWFtMRABGAs6DxILCgkKBXRlYW0xEAEYBQ=="
	const rulesSignature = "ClgKFHN1cGVyYWRtaW4xQGJhbmsuY29tEkCmLH/YfsuySq5RtE6qmeCvE9JMX4HmQ5kUO2nyKKy5W0a+d+G9gLg5G4HlJhyBqLJ+SBaqGt6rAqpRdyLFuR3bClgKFHN1cGVyYWRtaW4yQGJhbmsuY29tEkBGtV2np9r9usBC8IoR9zULLNfddCnZILPmFhTiFAwlzbQKoLTi1Q0pM5Wuq0uwyDSxXe4yNbqbBf/jkDpR9ZLFClgKFHN1cGVyYWRtaW4zQGJhbmsuY29tEkBVrGUvmlWaT6pHpbkgZ5orNpIEqEC8ss0mqPHDmTHeUbGZRpUB2aA+Zpt1oQ4656fu9bBqqcQl1h8tqaVU2EFi"

	_, wl, err := DecodeSignedWhitelistedAddress(env)
	require.NoError(t, err)

	// Empty wla with good filled envelope (no fields match)
	wla := &model.WLAddress{
		Envelope:        env,
		RulesContainer:  rulesContainer,
		RulesSignatures: rulesSignature,
	}

	ruler.On("VerifySuperAdminsSignatures", ctx, tenantID, mock.Anything, mock.Anything).Return(nil).Times(9)
	ruler.On("CheckWhitelistedAddress", ctx, tenantID, mock.Anything, mock.Anything, mock.Anything).Return(nil).Times(9)

	// Invalid address
	err = VerifyWLAddressesIntegrity(ctx, tenantID, ruler, wla, true, config.Blockchain{})
	require.Error(t, err)
	require.True(t, errors.Is(err, bizerr.InvalidWhitelistSignature))
	require.Contains(t, err.Error(), "field Address")

	// Invalid currency
	wla.Address = wl.GetAddress()
	err = VerifyWLAddressesIntegrity(ctx, tenantID, ruler, wla, true, config.Blockchain{})
	require.Error(t, err)
	require.True(t, errors.Is(err, bizerr.InvalidWhitelistSignature))
	require.Contains(t, err.Error(), "field Blockchain")

	// Invalid address type
	wla.Blockchain = constants.ToBlockchainSymbol(wl.GetBlockchain())
	err = VerifyWLAddressesIntegrity(ctx, tenantID, ruler, wla, true, config.Blockchain{})
	require.Error(t, err)
	require.True(t, errors.Is(err, bizerr.InvalidWhitelistSignature))
	require.Contains(t, err.Error(), "field AddressType")

	// Invalid label
	wla.AddressType = model.AddressType(wl.GetAddressType().String())
	err = VerifyWLAddressesIntegrity(ctx, tenantID, ruler, wla, true, config.Blockchain{})
	require.Error(t, err)
	require.True(t, errors.Is(err, bizerr.InvalidWhitelistSignature))
	require.Contains(t, err.Error(), "field Label")

	// Memo is valid ("" == "")

	// Invalid customer id
	wla.Label = wl.GetLabel()
	err = VerifyWLAddressesIntegrity(ctx, tenantID, ruler, wla, true, config.Blockchain{})
	require.Error(t, err)
	require.True(t, errors.Is(err, bizerr.InvalidWhitelistSignature))
	require.Contains(t, err.Error(), "field CustomerID")

	// Exchange account id is valid (0 == 0)
	// Contract type is valid ("" == "")

	// Valid
	wla.CustomerID = wl.GetCustomerId()
	err = VerifyWLAddressesIntegrity(ctx, tenantID, ruler, wla, true, config.Blockchain{})
	require.NoError(t, err)
}
