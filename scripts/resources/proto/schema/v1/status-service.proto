syntax = "proto3";

package tgvalidatord;

import "google/api/annotations.proto";
import "google/protobuf/empty.proto";
import "protoc-gen-openapiv2/options/annotations.proto";
import "status.proto";

option java_package = "com.taurushq.sdk.protect.proto.v1";

option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
  info: {
    title: "tg-validatord status service";
    version:"1.0";
    contact:{
      name:"tg-validatord status service";
      url:"https://github.com/taurusgroup/tg-validatord";
      email:"development@taurusgroup.ch";
    };
  };
  consumes:"application/json";
  produces:"application/json";
  schemes: [HTTP, HTTPS];
  security_definitions: {
    security: {
      key: "Bearer";
      value: {
        type: TYPE_API_KEY;
        in: IN_HEADER;
        name: "Authorization";
      }
    }
  }
  security: {
    security_requirement: {
      key: "Bearer";
      value: {};
    }
  }
  responses:{
    key:"401";
    value:{
      description:"Returned when the user is not authenticated.";
    }
  }
  responses:{
    key:"403";
    value:{
      description:"Returned when the user is not authorized to access the resource.";
    }
  }
  responses:{
    key:"404";
    value:{
      description:"Returned when the resource does not exist.";
    }
  }

};


message GetComponentStatusRequest {
  uint64 tenantId = 1;
}

message GetComponentStatusReply {
  ComponentStatus status = 1;
}

message GetAllComponentsStatusRequest {
  uint64 tenantId = 1;
}

message GetAllComponentsStatusReply {
  map<string, ComponentStatus> status = 1;
}

message GetGlobalComponentStatusRequest {
  uint64 tenantId = 1;
}

message GetGlobalComponentStatusReply {
  uint64 total = 1;
  uint64 working = 2;
  uint64 degraded = 3;
  uint64 failed = 4;
  string clusterStatus = 5;
  map<string, ComponentStatus> componentsStatus = 6;
}

message GetGroupStatusRequest {
  string group = 1;
  uint64 tenantId = 2;
}

message GetGroupStatusReply {
  GroupStatus status = 1;
}

message GetAllGroupsStatusRequest {
  string group = 1;
  uint64 tenantId = 2;
}

message GetAllGroupsStatusReply {
  uint64 total = 1;
  uint64 working = 2;
  uint64 failed = 3;
  string clusterGroupStatus = 4;
  map<string, GroupStatus> componentStatus = 5;
}

message GetConfigTenantReply {
  TenantConfig config = 1;
}

service StatusService {

  //////////////////
  ////  Config  ////
  //////////////////
  rpc GetConfigTenant (google.protobuf.Empty) returns (GetConfigTenantReply) {
    option (google.api.http) = {
      get: "/api/rest/v1/config/tenant"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get some configuration of the tenant";
      description: "This endpoint return the configuration of the tenant of the connected user";
      tags: "Config";
    };
  };

  //////////////////
  ////  Health  ////
  //////////////////
  rpc GetGroupStatus (GetGroupStatusRequest) returns (GetGroupStatusReply) {
    option (google.api.http) = {
      get: "/api/rest/v1/status/{group}"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "List the health statuses of a group";
      description: "This endpoint returns a list of the health statuses of a given group";
      tags: "Health";
      security: {}; // Disable security key
    };
  };

  rpc GetAllGroupsStatus (GetAllGroupsStatusRequest) returns (GetAllGroupsStatusReply) {
    option (google.api.http) = {
      get: "/api/rest/v1/status/{group}/all"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "List all health statuses of a group";
      description: "This endpoint returns a list of all health statuses of a given group";
      tags: "Health";
      security: {}; // Disable security key
    };
  };

  // It is important that this is defined AFTER the more generic /api/rest/v1/status/{group} routes

  rpc GetAllComponentsStatus (GetAllComponentsStatusRequest) returns (GetAllComponentsStatusReply) {
    option (google.api.http) = {
      get: "/api/rest/v1/status/all"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "List all health statuses";
      description: "This endpoint returns a list of all health statuses";
      tags: "Health";
      security: {}; // Disable security key
    };
  };

  rpc GetGlobalComponentStatus (GetGlobalComponentStatusRequest) returns (GetGlobalComponentStatusReply) {
    option (google.api.http) = {
      get: "/api/rest/v1/status/global"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get the global health status";
      description: "This endpoint returns the global health status";
      tags: "Health";
      security: {}; // Disable security key
    };
  };

  rpc GetComponentStatus (GetComponentStatusRequest) returns (GetComponentStatusReply) {
    option (google.api.http) = {
      get: "/api/rest/v1/status"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get the component health status";
      description: "This endpoint returns the component health status";
      tags: "Health";
      security: {}; // Disable security key
    };
  };
}
